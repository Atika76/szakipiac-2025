<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SzakiPiac-2025.hu – Find trusted pros</title>

  <!-- Icons (from repo root) -->
  <link rel="icon" sizes="192x192" href="../icon-192.png" />
  <link rel="icon" sizes="512x512" href="../icon-512.png" />

  <!-- UI libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />

  <!-- Supabase + PayPal + image-compress -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Try shared config; if it 404-ol, a fallback alább gondoskodik róla -->
  <script src="../supabase.js"></script>
  <script>
    // Fallback Supabase client (ha a ../supabase.js nem hozta létre)
    if (typeof window.supaClient === "undefined") {
      const SUPABASE_URL = "https://bxtpnotswnwrbycvfypz.supabase.co";
      const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4dHBub3Rzd253cmJ5Y3ZmeXB6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MTQ0NDcsImV4cCI6MjA2ODQ5MDQ0N30.CXEfo_8qmIYhkEZFdTsbl9ZB-PRTP6UK8EbIxxpSGZc";
      window.supaClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    }
  </script>
  <script src="https://www.paypal.com/sdk/js?client-id=AQsaQCLj0og2wsfMoDKAqxJieD2cgXwWq5cssAJCJbO2KoYE8LGHCREyR4vMzMfKZK68qw6EY7IAxMYF&currency=HUF"></script>
  <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2/dist/browser-image-compression.js"></script>

  <style>
    body{font-family:Inter,system-ui,Arial,Helvetica,sans-serif;background:#f7fafc;color:#1f2937}
    .page-content{display:none}
    .loader{width:40px;height:40px;border-radius:9999px;border:4px solid #eee;border-top-color:#2d3748;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .flag{width:16px;height:12px;display:inline-block;vertical-align:baseline;border:1px solid rgba(0,0,0,.15);border-radius:2px;overflow:hidden}
  </style>
</head>
<body>

  <!-- Language switcher -->
  <div class="fixed top-2 right-3 z-[60] text-xs text-gray-600 bg-white/80 backdrop-blur px-2 py-1 rounded-md shadow-sm">
    <a href="../index.html" class="hover:underline mr-2" title="Magyar">
      <span class="flag align-[-1px]">
        <svg viewBox="0 0 3 2" width="16" height="12">
          <rect width="3" height="2" fill="#fff"/>
          <rect width="3" height="0.6667" y="0" fill="#ce2939"/>
          <rect width="3" height="0.6667" y="1.3333" fill="#477050"/>
        </svg>
      </span> HU
    </a>
    <span class="opacity-60">|</span>
    <span class="ml-2" title="English">
      <span class="flag align-[-1px]">
        <svg viewBox="0 0 60 30" width="16" height="12">
          <clipPath id="s-en"><path d="M0,0 v30 h60 v-30 z"/></clipPath>
          <clipPath id="t-en"><path d="M30,15 h30 v15 z v15 h-30 z h-30 v-15 z v-15 h30 z"/></clipPath>
          <g clip-path="url(#s-en)">
            <path d="M0,0 v30 h60 v-30 z" fill="#012169"/>
            <path d="M0,0 L60,30 M60,0 L0,30" stroke="#fff" stroke-width="6"/>
            <path d="M0,0 L60,30 M60,0 L0,30" clip-path="url(#t-en)" stroke="#C8102E" stroke-width="4"/>
            <path d="M30,0 v30 M0,15 h60" stroke="#fff" stroke-width="10"/>
            <path d="M30,0 v30 M0,15 h60" stroke="#C8102E" stroke-width="6"/>
          </g>
        </svg>
      </span> EN
    </span>
  </div>

  <!-- Header -->
  <header class="bg-white shadow-md sticky top-0 z-50">
    <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <a href="#home" class="nav-link-logo flex items-center gap-2 font-extrabold text-xl text-gray-800">
          <img class="h-8 w-8" src="../icon-192.png" alt="SzakiPiac logo">
          <span>SzakiPiac-2025.hu</span>
        </a>

        <div class="hidden md:flex items-center gap-1">
          <a href="#home" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Home</a>
          <a href="#about" class="nav-link px-3 py-2 rounded-md text-sm font-medium">About</a>
          <a href="#contact" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Contact</a>
          <a href="#post" class="nav-link px-3 py-2 rounded-md text-sm font-medium bg-green-600 text-white">Post an Ad</a>
        </div>

        <div class="flex items-center gap-2">
          <div id="nav-auth-section" class="hidden md:block"></div>
          <button id="mobile-menu-button" class="md:hidden p-2 text-gray-600" aria-label="Menu">
            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
          </button>
        </div>
      </div>

      <div id="mobile-menu" class="md:hidden hidden">
        <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
          <a href="#home" class="nav-link block px-3 py-2 rounded-md">Home</a>
          <a href="#about" class="nav-link block px-3 py-2 rounded-md">About</a>
          <a href="#contact" class="nav-link block px-3 py-2 rounded-md">Contact</a>
          <a href="#post" class="nav-link block px-3 py-2 rounded-md bg-green-600 text-white">Post an Ad</a>
          <div id="mobile-nav-auth-section" class="pt-4 mt-4 border-t"></div>
        </div>
      </div>
    </nav>
  </header>

  <!-- Main -->
  <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div id="main-loader" class="page-content flex justify-center items-center py-20" style="display:none">
      <div class="loader"></div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <div class="lg:col-span-2">
        <div id="home-page" class="page-content"></div>
        <div id="about-page" class="page-content"></div>
        <div id="contact-page" class="page-content"></div>
        <div id="post-page" class="page-content"></div>
        <div id="auth-page" class="page-content"></div>
        <div id="admin-page" class="page-content"></div>
      </div>

      <aside class="hidden lg:block space-y-6">
        <div class="bg-white p-6 rounded-lg shadow-sm">
          <h3 class="text-lg font-semibold text-center mb-4">Partners & offers</h3>
          <div id="ad-slider" class="relative overflow-hidden rounded-lg shadow-md" style="height: 260px;">
            <div id="ad-slides"></div>
            <div id="ad-dots" class="absolute bottom-2 left-1/2 -translate-x-1/2 flex gap-2"></div>
            <button id="slider-prev" class="absolute top-1/2 left-2 -translate-y-1/2 bg-white/80 p-2 rounded-full shadow z-10" aria-label="Prev">
              <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 19l-7-7 7-7"/></svg>
            </button>
            <button id="slider-next" class="absolute top-1/2 right-2 -translate-y-1/2 bg-white/80 p-2 rounded-full shadow z-10" aria-label="Next">
              <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5l7 7-7 7"/></svg>
            </button>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Lightbox -->
  <div id="lightbox" class="fixed inset-0 bg-black/75 z-[100] hidden items-center justify-center opacity-0 transition">
    <span id="lightbox-close" class="absolute top-4 right-6 text-white text-5xl font-bold cursor-pointer">&times;</span>
    <img id="lightbox-img" class="max-w-[90%] max-h-[85%] rounded-lg">
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-x-[120%] transition duration-300 z-[110]"></div>

<script>
/* ===== Config ===== */
const ADMIN_EMAIL = "atika.76@windowslive.com";

/* ===== Helpers ===== */
function showToast(msg,type="success"){
  const el=document.getElementById("toast");
  el.textContent=msg;
  el.className=`fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transform transition duration-300 z-[110] ${type==='error'?'bg-red-500':'bg-green-500'}`;
  el.classList.remove("translate-x-[120%]");
  setTimeout(()=>el.classList.add("translate-x-[120%]"),4000);
}
function ytEmbed(url){
  if(!url) return null;
  try{
    const u=new URL(url); let id;
    if(u.hostname==="youtu.be") id=u.pathname.slice(1);
    else if(u.hostname.includes("youtube.com")&&u.searchParams.has("v")) id=u.searchParams.get("v");
    return id?`https://www.youtube.com/embed/${id}`:null;
  }catch{return null}
}

/* ===== Slider content (no text-in-image) ===== */
function sliderItems(){
  return [
    { type:'html', html:()=>`
      <a href="#post" class="block w-full h-[250px] p-6 rounded-xl bg-yellow-300/70 hover:brightness-105 transition">
        <div class="text-2xl font-extrabold leading-snug">Reach thousands of prospects!</div>
        <div class="text-lg mt-1">Advertise now on <b>SzakiPiac-2025</b><span class="text-red-600">.hu</span>!</div>
      </a>` },
    { type:'img', url:"https://www.alza.hu/", img:"https://upload.wikimedia.org/wikipedia/commons/1/1f/Alza.cz_logo.svg", alt:"Alza.hu" },
    { type:'img', url:"https://www.emag.hu/", img:"https://upload.wikimedia.org/wikipedia/commons/a/af/Logo_eMAG_%282019%29.svg", alt:"eMAG" }
  ];
}
let slideIdx=0, slideTimer=null;
function renderSlide(i){
  const host=document.getElementById("ad-slides"); const items=sliderItems(); const ad=items[i];
  host.innerHTML = ad.type==='html'
    ? ad.html()
    : `<a href="${ad.url}" target="_blank" rel="noopener sponsored" class="block w-full h-[250px]">
         <img src="${ad.img}" alt="${ad.alt||''}" class="w-full h-full object-contain p-2 bg-white rounded-md shadow">
       </a>`;
  document.getElementById("ad-dots").innerHTML = items.map((_,k)=>`
    <button class="w-3 h-3 rounded-full border-2 ${k===i?'bg-green-600 border-green-700':'bg-white border-gray-400'}"
            onclick="showSlide(${k})" aria-label="Slide ${k+1}"></button>`).join("");
}
function showSlide(i){slideIdx=i;renderSlide(slideIdx);resetTimer()}
function prevSlide(){const items=sliderItems();slideIdx=(slideIdx-1+items.length)%items.length;renderSlide(slideIdx);resetTimer()}
function nextSlide(){const items=sliderItems();slideIdx=(slideIdx+1)%items.length;renderSlide(slideIdx);resetTimer()}
function resetTimer(){if(slideTimer)clearInterval(slideTimer);const items=sliderItems();if(items.length>1)slideTimer=setInterval(nextSlide,4000)}

/* ===== Router ===== */
const router = {
  '#home': showHome,
  '#about': showAbout,
  '#contact': showContact,
  '#post': showPost,
  '#auth': showAuth,
  '#admin': showAdmin
};
function showPage(id){
  document.querySelectorAll(".page-content").forEach(p=>{if(p.id!=="main-loader")p.style.display="none"});
  document.getElementById(id+"-page").style.display="block";
}
async function handleRouteChange(){
  const hash=location.hash||"#home";
  document.querySelectorAll(".page-content").forEach(p=>p.style.display="none");
  const loader=document.getElementById("main-loader"); loader.style.display="flex";
  const fn=router[hash]||router["#home"];
  try{await fn()}catch(e){console.error(e)}finally{loader.style.display="none";showPage(hash.substring(1))}
  document.querySelectorAll(".nav-link").forEach(a=>a.classList.toggle("bg-gray-100",a.getAttribute("href")===hash));
  document.getElementById("mobile-menu").classList.add("hidden");
}

/* ===== Pages ===== */
async function showHome(){
  const el=document.getElementById("home-page");
  el.innerHTML = `
    <div class="text-center mb-8">
      <h1 class="text-4xl font-extrabold">Welcome to <span class="text-green-600">SzakiPiac-2025.hu</span>!</h1>
      <p class="mt-3 text-lg text-gray-600">Find trusted professionals or post an ad and get new clients.</p>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-sm mb-8">
      <h2 class="text-2xl font-bold text-center mb-4">Browse listings</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <input id="search-input" class="md:col-span-2 w-full border-gray-300 rounded-md" placeholder="Search by trade or name..." />
        <select id="category-select" class="w-full border-gray-300 rounded-md">
          <option value="">All categories</option>
          <!-- Display EN, value HU (compat az adatbázissal) -->
          <option value="Építőipar">Construction</option>
          <option value="Villanyszerelés">Electrical</option>
          <option value="Gépészet">HVAC / Mechanics</option>
          <option value="Festés">Painting</option>
          <option value="Lakberendezés">Interior design</option>
          <option value="Számítástechnika">IT & Computing</option>
          <option value="Kertépítés, karbantartás">Landscaping & maintenance</option>
          <option value="Egyéb">Other</option>
        </select>
      </div>
    </div>

    <div id="ads-list" class="space-y-6">
      <div class="flex justify-center py-10"><div class="loader"></div></div>
    </div>`;
  el.querySelector("#search-input").addEventListener("input",applyFilter);
  el.querySelector("#category-select").addEventListener("change",applyFilter);
  await loadAds();
}
async function showAbout(){
  document.getElementById("about-page").innerHTML = `
    <div class="bg-white p-8 rounded-lg shadow-sm">
      <h1 class="text-3xl font-extrabold mb-6">About</h1>
      <p class="mb-4 text-gray-700"><b>SzakiPiac-2025.hu</b> connects customers and professionals across Hungary — simply, quickly and reliably.</p>
      <ul class="space-y-3 my-6">
        <li><b>✔</b> Direct access to verified pros with ratings.</li>
        <li><b>✔</b> Clear, organized marketplace.</li>
        <li><b>✔</b> Fast search by category and keyword.</li>
        <li><b>✔</b> Free and paid listing packages.</li>
        <li><b>✔</b> Easy posting and client contact.</li>
      </ul>
      <p class="mb-4 text-gray-700"><b>Our mission:</b> Quality work and satisfied clients — we support local businesses so everyone can find the best professional for any job.</p>
      <h3 class="text-2xl font-bold mt-8 mb-4">Why choose us?</h3>
      <ul class="list-disc list-inside space-y-2 text-gray-700">
        <li>Fast, secure listing management</li>
        <li>User-friendly interface</li>
        <li>Helpful support</li>
        <li>Continuous improvements</li>
      </ul>
    </div>`;
}
async function showContact(){
  const c=document.getElementById("contact-page");
  c.innerHTML = `
    <div class="bg-white p-8 rounded-lg shadow-sm">
      <h1 class="text-3xl font-extrabold mb-6">Contact</h1>
      <div class="grid md:grid-cols-2 gap-12">
        <div>
          <h3 class="text-xl font-semibold">Get in touch</h3>
          <p class="mt-4"><b>Email:</b> <a href="mailto:szakipiac2025@gmail.com" class="text-green-600">szakipiac2025@gmail.com</a></p>
        </div>
        <div>
          <h3 class="text-xl font-semibold mb-4">Write to us</h3>
          <form id="contact-form" class="space-y-4">
            <div><label>Name</label><input id="c-name" class="mt-1 block w-full border-gray-300 rounded-md" required></div>
            <div><label>Email address</label><input id="c-email" type="email" class="mt-1 block w-full border-gray-300 rounded-md" required></div>
            <div><label>Message</label><textarea id="c-msg" rows="4" class="mt-1 block w-full border-gray-300 rounded-md" required></textarea></div>
            <button class="w-full bg-green-600 text-white py-2 rounded-md">Send message</button>
          </form>
        </div>
      </div>
    </div>`;
  c.querySelector("#contact-form").addEventListener("submit",e=>{
    e.preventDefault();showToast("Thanks for your message! (Demo.)","info");e.target.reset();
  });
}
async function showAuth(){
  const el=document.getElementById("auth-page");
  const { data:{ session } } = await supaClient.auth.getSession();
  if(session){
    el.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-sm text-center"><h1 class="text-2xl font-bold mb-4">You are already signed in.</h1><p class="text-gray-600">${session.user.email}</p></div>`;
    return;
  }
  el.innerHTML = `
    <div class="bg-white p-8 rounded-lg shadow-sm max-w-md mx-auto">
      <h2 id="auth-title" class="text-2xl font-bold text-center mb-6">Sign in</h2>
      <form id="auth-form" class="space-y-6">
        <div><label class="block text-sm">Email</label><input id="email" type="email" required class="mt-1 w-full border-gray-300 rounded-md"></div>
        <div><label class="block text-sm">Password</label><input id="password" type="password" required class="mt-1 w-full border-gray-300 rounded-md"></div>
        <button id="auth-submit" class="w-full text-white bg-green-600 hover:bg-green-700 py-2 rounded-md">Sign in</button>
      </form>
      <div class="mt-6 text-center"><a href="#" id="auth-switch" class="text-sm text-green-600 hover:text-green-500">No account yet? Register!</a></div>
    </div>`;
  let login=true;
  el.querySelector("#auth-form").addEventListener("submit",async e=>{
    e.preventDefault();
    const email=e.target.email.value, password=e.target.password.value;
    try{
      const { error } = login ? await supaClient.auth.signInWithPassword({email,password})
                              : await supaClient.auth.signUp({email,password});
      if(error) throw error;
      showToast(login?"Signed in successfully!":"Registered successfully!");
      location.hash="#home";
    }catch(err){showToast("Error: "+err.message,"error")}
  });
  el.querySelector("#auth-switch").addEventListener("click",e=>{
    e.preventDefault(); login=!login;
    el.querySelector("#auth-title").textContent=login?"Sign in":"Sign up";
    el.querySelector("#auth-submit").textContent=login?"Sign in":"Sign up";
    e.target.textContent=login?"No account yet? Register!":"Already have an account? Sign in!";
  });
}
async function showPost(){
  const el=document.getElementById("post-page");
  const { data:{ session } } = await supaClient.auth.getSession();
  const warn = !session? `<div class="bg-blue-100 border-l-4 border-blue-500 text-blue-800 p-4 mb-6 rounded-md"><b>You must sign in to post an ad!</b> <a href="#auth" class="font-bold underline">Click here to sign in</a>.</div>` : ``;
  window._imgs=[];

  el.innerHTML = `
    <div class="bg-white p-8 rounded-lg shadow-sm">
      ${warn}
      <h1 class="text-3xl font-extrabold mb-2">Post an Ad</h1>
      <p class="text-gray-600 mb-8">Fill in the form or use the AI helper.</p>

      <div class="bg-indigo-50 border border-indigo-200 p-6 rounded-lg mb-8">
        <h2 class="text-xl font-semibold text-indigo-800 mb-3">✨ AI Ad Helper</h2>
        <div class="flex flex-col sm:flex-row gap-2">
          <input id="ai-kw" class="flex-grow w-full px-4 py-2 border-indigo-300 rounded-md" placeholder="Keywords, e.g. 'painter, Budapest'">
          <button id="ai-btn" class="inline-flex items-center justify-center px-4 py-2 text-sm text-white bg-indigo-600 rounded-md">Generate text</button>
        </div>
      </div>

      <form id="post-form" class="space-y-6">
        <div><label class="block text-sm">Title</label><input id="title" required class="mt-1 w-full border-gray-300 rounded-md"></div>
        <div><label class="block text-sm">Description</label><textarea id="desc" rows="6" required class="mt-1 w-full border-gray-300 rounded-md"></textarea></div>

        <div class="grid md:grid-cols-2 gap-6">
          <div><label class="block text-sm">Category</label>
            <select id="cat" required class="mt-1 w-full border-gray-300 rounded-md">
              <option value="">Choose...</option>
              <option value="Építőipar">Construction</option>
              <option value="Villanyszerelés">Electrical</option>
              <option value="Gépészet">HVAC / Mechanics</option>
              <option value="Festés">Painting</option>
              <option value="Lakberendezés">Interior design</option>
              <option value="Számítástechnika">IT & Computing</option>
              <option value="Kertépítés, karbantartás">Landscaping & maintenance</option>
              <option value="Egyéb">Other</option>
            </select>
          </div>
          <div><label class="block text-sm">Phone (optional)</label><input id="phone" placeholder="+36..." class="mt-1 w-full border-gray-300 rounded-md"></div>
          <div><label class="block text-sm">Website (optional)</label><input id="website" placeholder="https://..." class="mt-1 w-full border-gray-300 rounded-md"></div>
          <div id="yt-wrap" class="hidden"><label class="block text-sm">YouTube link (optional)</label><input id="yt" placeholder="https://www.youtube.com/watch?v=..." class="mt-1 w-full border-gray-300 rounded-md"></div>
        </div>

        <div><label class="block text-sm">Price (HUF, optional)</label><input id="price" type="number" min="0" placeholder="Negotiable" class="mt-1 w-full border-gray-300 rounded-md"></div>

        <div>
          <label class="block text-sm">Package</label>
          <select id="pkg" required class="mt-1 w-full border-gray-300 rounded-md">
            <option value="basic_0_2">Basic (free, 2 images)</option>
            <option value="premium_1990_4">Premium (1990 HUF, 4 images)</option>
            <option value="extra_2990_8">Extra (2990 HUF, 8 images)</option>
          </select>
        </div>

        <div id="pkg-desc" class="mt-4 p-4 bg-gray-50 rounded-lg border text-sm"></div>

        <div>
          <label class="block text-sm">Images (<span id="max-imgs">2</span> pcs)</label>
          <label class="inline-block mt-1 cursor-pointer text-green-600 underline">
            Choose files... <input id="img-input" type="file" multiple accept="image/*" class="sr-only">
          </label>
          <div id="img-previews" class="mt-4 grid grid-cols-3 sm:grid-cols-5 gap-4"></div>
        </div>

        <div class="border-t pt-6">
          <div id="free-submit"><button id="submit-btn" class="w-full bg-green-600 text-white py-3 rounded-md">Submit ad</button></div>
          <div id="paypal-wrap" class="hidden"></div>
        </div>
      </form>
    </div>`;

  // events
  el.querySelector("#ai-btn").addEventListener("click",genAiText);
  el.querySelector("#pkg").addEventListener("change",onPkgChange);
  el.querySelector("#img-input").addEventListener("change",onImgPick);
  el.querySelector("#submit-btn").addEventListener("click",(e)=>{e.preventDefault();submitAd()});
  onPkgChange();
}
async function showAdmin(){
  const el=document.getElementById("admin-page");
  el.innerHTML=`<div class="flex justify-center py-10"><div class="loader"></div></div>`;
  const { data:{ session } } = await supaClient.auth.getSession();
  if(!session || session.user.email!==ADMIN_EMAIL){
    el.innerHTML = `<p class="text-red-500 text-center">You don't have permission to view this page.</p>`;
    return;
  }
  try{
    const { data:list, error } = await supaClient.from("hirdetesek").select("*").order("created_at",{ascending:false});
    if(error) throw error;
    el.innerHTML = `
      <h2 class="text-2xl font-extrabold mb-4">Administration - Manage Listings</h2>
      <div class="bg-white rounded-lg shadow-sm overflow-x-auto">
        <table class="w-full text-sm text-left">
          <thead class="bg-gray-50"><tr>
            <th class="p-4">Title</th><th class="p-4">User</th><th class="p-4">Expires</th><th class="p-4">Actions</th>
          </tr></thead>
          <tbody>
            ${list.map(h=>`<tr class="border-b">
              <td class="p-4">${h.cim}</td>
              <td class="p-4">${h.email}</td>
              <td class="p-4 whitespace-nowrap">${h.lejárati_datum?(new Date(h.lejárati_datum)).toLocaleDateString('en-GB'):'N/A'}</td>
              <td class="p-4"><button onclick="deleteAd('${h.id}')" class="text-red-600 hover:underline">Delete</button></td>
            </tr>`).join("")}
          </tbody>
        </table>
      </div>`;
  }catch(e){ el.innerHTML = `<p class="text-red-500 text-center">Error loading listings: ${e.message}</p>`; }
}

/* ===== Data + actions ===== */
async function loadAds(){
  const host=document.getElementById("ads-list");
  try{
    const { data, error } = await supaClient.from("hirdetesek").select("*").gte("lejárati_datum",(new Date).toISOString());
    if(error) throw error;
    const weight={extra:3,premium:2,basic:1,alap:1};
    data.sort((a,b)=> (weight[b.csomag]||0)-(weight[a.csomag]||0) || (new Date(b.created_at)-new Date(a.created_at)));
    window._ads=data;
    renderAds(data);
  }catch(e){ host.innerHTML = `<p class="text-center text-red-600">Error loading listings.</p>`; }
}
function renderAds(list){
  const host=document.getElementById("ads-list");
  if(!list?.length){
    host.innerHTML = `<p class="text-center text-gray-500">There are no active listings yet. Be the first!</p>`;
    return;
  }
  host.innerHTML = list.map(h=>{
    const yt=ytEmbed(h.video_url);
    const video = yt?`<div class="aspect-video my-4 rounded-lg overflow-hidden shadow"><iframe src="${yt}" allowfullscreen class="w-full h-full"></iframe></div>`:"";
    const imgs=(h.kep_url_tomb||[]).length?`<div class="flex flex-wrap gap-2 mb-4">${h.kep_url_tomb.map(u=>`<img src="${u}" class="h-20 w-20 object-cover rounded-md cursor-pointer" onclick="openLightbox('${u}')">`).join("")}</div>`:"";
    const price = h.ar ? (Number(h.ar).toLocaleString("en-US")+" HUF") : "Negotiable";
    return `
      <div class="bg-white p-6 rounded-lg shadow-sm relative ${h.csomag==='extra'?'border-2 border-yellow-400':''}">
        ${h.csomag==='extra'?`<div class="absolute top-0 right-0 -mt-3 -mr-3 bg-yellow-400 text-white text-xs font-bold px-2 py-1 rounded-full shadow">EXTRA</div>`:""}
        <div class="flex justify-between items-start">
          <div>
            <p class="text-sm font-medium text-green-600">${h.kategoria||""}</p>
            <h3 class="text-xl font-bold mt-1">${h.cim}</h3>
          </div>
          <p class="text-lg font-semibold">${price}</p>
        </div>
        <p class="text-gray-600 my-4">${h.leiras}</p>
        ${video}${imgs}
        <div class="flex flex-wrap gap-2 pt-4 border-t justify-between items-center">
          <div>
            <a class="px-3 py-1.5 text-sm text-white bg-green-600 rounded-md" href="mailto:${h.email}">Contact (Email)</a>
            ${h.telefonszam?`<a class="px-3 py-1.5 text-sm bg-gray-200 rounded-md" href="tel:${h.telefonszam}">Contact (Phone)</a>`:""}
            ${h.weboldal?`<a class="px-3 py-1.5 text-sm text-white bg-blue-600 rounded-md" rel="noopener nofollow" target="_blank" href="${h.weboldal}">Website</a>`:""}
          </div>
          ${window._sessionEmail===ADMIN_EMAIL?`<button onclick="deleteAd('${h.id}')" class="px-3 py-1.5 text-sm text-white bg-red-600 rounded-md">Delete</button>`:""}
        </div>
      </div>`;
  }).join("");
}
function applyFilter(){
  const q=document.getElementById("search-input").value.toLowerCase();
  const cat=document.getElementById("category-select").value;
  const list=(window._ads||[]).filter(h=>{
    const mTxt=`${h.cim} ${h.leiras}`.toLowerCase().includes(q);
    const mCat=!cat || h.kategoria===cat;
    return mTxt && mCat;
  });
  renderAds(list);
}

/* ===== Upload & posting ===== */
function onImgPick(e){
  const files=[...e.target.files];
  const max=parseInt(document.getElementById('max-imgs').textContent,10);
  if((window._imgs.length+files.length)>max){
    showToast(`Maximum ${max} images allowed.`,'error');
    e.target.value=''; return;
  }
  showToast('Optimizing images...','info');
  const opts={maxSizeMB:1,maxWidthOrHeight:1280,useWebWorker:true};
  (async()=>{
    const out=[];
    for(const f of files){ out.push(await imageCompression(f,opts)) }
    window._imgs.push(...out);
    e.target.value=''; renderImgPreviews();
  })().catch(()=>showToast('Image optimization failed.','error'));
}
function renderImgPreviews(){
  const box=document.getElementById("img-previews");
  box.innerHTML="";
  window._imgs.forEach((f,i)=>{
    const r=new FileReader;
    r.onload=e=>{
      const w=document.createElement('div'); w.className="relative group";
      const img=document.createElement('img'); img.src=e.target.result; img.className="w-full h-full object-cover rounded-md border-2 border-gray-200";
      const del=document.createElement('button'); del.type="button"; del.innerHTML="&times;";
      del.className="absolute -top-2 -right-2 bg-red-600 text-white rounded-full h-6 w-6 flex items-center justify-center text-lg font-bold opacity-0 group-hover:opacity-100";
      del.onclick=()=>{window._imgs.splice(i,1);renderImgPreviews()};
      w.appendChild(img); w.appendChild(del); box.appendChild(w);
    };
    r.readAsDataURL(f);
  });
}
function onPkgChange(){
  const s=document.getElementById("pkg"); const [name,price,max]=s.value.split("_");
  document.getElementById("max-imgs").textContent=max;

  // features box
  const features = {
    basic:   ["Upload 2 images","Active for 7 days"],
    premium: ["Upload 4 images","Active for 14 days","✅ YouTube video embed"],
    extra:   ["Upload 8 images","Active for 30 days","✅ YouTube video embed","⭐ Highlighted listing"]
  }[name] || [];
  document.getElementById("pkg-desc").innerHTML =
    `<h4 class="font-semibold text-gray-700 mb-2">Included in package:</h4>
     <ul class="list-disc list-inside text-gray-600 space-y-1">${features.map(f=>`<li>${f}</li>`).join("")}</ul>`;

  // show/hide YouTube
  const y=document.getElementById("yt-wrap");
  y.classList.toggle("hidden",!(name==="premium"||name==="extra"));

  // free vs paypal
  const free=document.getElementById("free-submit");
  const pp=document.getElementById("paypal-wrap");
  (window._sessionEmail===ADMIN_EMAIL||price==0)
    ? (free.style.display="block",pp.style.display="none",pp.innerHTML="")
    : (free.style.display="none",pp.style.display="block",pp.innerHTML="", paypal.Buttons({
        createOrder:(d,a)=>{ if(!getAd()) return Promise.reject(new Error("invalid")); return a.order.create({purchase_units:[{description:`SzakiPiac package: ${name}`,amount:{currency_code:"HUF",value:price}}]})},
        onApprove:(d,a)=>a.order.capture().then(()=>submitAd()),
        onError:()=>showToast("An error occurred during PayPal payment.","error")
      }).render("#paypal-wrap"));
}
async function genAiText(){
  const kw=document.getElementById("ai-kw").value.trim();
  if(!kw){showToast("Please add some keywords!","error");return}
  const btn=document.getElementById("ai-btn"); const old=btn.textContent; btn.disabled=true; btn.textContent="Generating...";
  try{
    const { data, error } = await supaClient.functions.invoke("generate-ad",{body:{keywords:kw}});
    if(error) throw new Error(error.message||"Function error");
    document.getElementById("title").value=data.cim; document.getElementById("desc").value=data.leiras;
    showToast("Generated successfully!","success");
  }catch(e){showToast("Error while generating: "+e.message,"error")}
  finally{btn.disabled=false; btn.textContent=old}
}
async function submitAd(){
  const { data:{ session } } = await supaClient.auth.getSession();
  if(!session){showToast("You must sign in to post!","error");return}
  const ad=getAd(); if(!ad) return;
  showToast("Uploading...","info");
  try{
    const urls=await uploadImgs(window._imgs||[]);
    await saveAd(ad,urls);
  }catch(e){showToast(`Error: ${e.message}`,"error")}
}
function getAd(){
  const title=document.getElementById("title").value;
  const desc=document.getElementById("desc").value;
  if(!title||!desc){showToast("Title and Description are required!","error");return null}
  return {
    cim:title, leiras:desc, kategoria:document.getElementById("cat").value,
    ar:document.getElementById("price").value||null, telefonszam:document.getElementById("phone").value||null,
    weboldal:document.getElementById("website").value||null, video_url:document.getElementById("yt").value||null
  };
}
async function uploadImgs(files){
  const { data:{ session } } = await supaClient.auth.getSession();
  if(!session||!files.length) return [];
  const ups = await Promise.all(files.map(f=>supaClient.storage.from("hirdetes-kepek").upload(`${session.user.id}/${Date.now()}_${f.name}`,f)));
  const urls=[]; for(const r of ups){ if(r.error) throw r.error; const { data } = supaClient.storage.from("hirdetes-kepek").getPublicUrl(r.data.path); urls.push(data.publicUrl) }
  return urls;
}
async function saveAd(ad,urls){
  const { data:{ session } } = await supaClient.auth.getSession();
  const pkg=document.getElementById("pkg").value.split("_")[0];
  const days={basic:7,premium:14,extra:30,alap:7}[pkg]||7;
  const exp=new Date(); exp.setDate(exp.getDate()+days);
  const { error } = await supaClient.from("hirdetesek").insert({...ad,user_id:session.user.id,email:session.user.email,csomag:pkg,kep_url_tomb:urls,lejárati_datum:exp.toISOString()});
  if(error){showToast(`Save error: ${error.message}`,"error")} else {showToast("Ad posted successfully!","success");location.hash="#home"}
}
async function deleteAd(id){
  if(!confirm("Are you sure you want to delete this ad? This cannot be undone.")) return;
  try{
    const { data:ad } = await supaClient.from("hirdetesek").select("kep_url_tomb").eq("id",id).single();
    if(ad?.kep_url_tomb?.length){
      const files=ad.kep_url_tomb.map(u=>(new URL(u)).pathname.split("/hirdetes-kepek/")[1]);
      await supaClient.storage.from("hirdetes-kepek").remove(files);
    }
    const { error } = await supaClient.from("hirdetesek").delete().eq("id",id);
    if(error) throw error;
    showToast("Ad deleted successfully.","success");
    loadAds();
  }catch(e){showToast("Error: "+e.message,"error")}
}

/* ===== Boot ===== */
document.addEventListener("DOMContentLoaded",async()=>{
  // lightbox
  const lb=document.getElementById("lightbox");
  document.getElementById("lightbox-close").addEventListener("click",()=>{lb.classList.add("opacity-0");setTimeout(()=>lb.classList.add("hidden"),300)});
  window.openLightbox=(url)=>{document.getElementById("lightbox-img").src=url;lb.classList.remove("hidden");setTimeout(()=>lb.classList.remove("opacity-0"),10)};

  // auth UI
  const { data:{ session } } = await supaClient.auth.getSession();
  window._sessionEmail = session?.user?.email || null;
  const nav=document.getElementById("nav-auth-section");
  const mnav=document.getElementById("mobile-nav-auth-section");
  let html="";
  if(session){
    const isAdmin = session.user.email===ADMIN_EMAIL;
    html=`<div class="flex items-center gap-4"><span class="text-sm hidden lg:inline">${session.user.email}</span>${isAdmin?`<a href="#admin" class="text-sm font-medium text-yellow-600">Admin</a>`:""}<button id="logoutBtn" class="text-sm font-medium">Sign out</button></div>`;
  }else{
    html=`<a href="#auth" class="text-base font-medium text-gray-500 hover:text-gray-900">Sign in</a>`;
  }
  nav.innerHTML=html; mnav.innerHTML=html.replace("hidden lg:inline","");
  if(session) document.querySelectorAll("#logoutBtn").forEach(b=>b.addEventListener("click",async()=>{await supaClient.auth.signOut();showToast("Signed out successfully!");location.hash="#home"}));

  // router + slider + nav
  handleRouteChange();
  window.addEventListener("hashchange",handleRouteChange);
  document.querySelectorAll(".nav-link, .nav-link-logo").forEach(a=>{
    a.addEventListener("click",e=>{e.preventDefault();location.hash=(new URL(a.href)).hash})
  });
  document.getElementById("mobile-menu-button").addEventListener("click",()=>document.getElementById("mobile-menu").classList.toggle("hidden"));

  renderSlide(slideIdx);
  document.getElementById("slider-prev")?.addEventListener("click",prevSlide);
  document.getElementById("slider-next")?.addEventListener("click",nextSlide);
  resetTimer();

  supaClient.auth.onAuthStateChange(async()=>{
    const { data:{ session } } = await supaClient.auth.getSession();
    window._sessionEmail=session?.user?.email||null;
    handleRouteChange();
  });
});
</script>
</body>
</html>
