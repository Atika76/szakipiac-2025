<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Hirdetés feltöltés</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="logo.png">
  <link rel="stylesheet" href="style.css">
  <style>
    #image-previews { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; border: 1px solid #eee; padding: 10px; min-height: 50px; border-radius: 5px; }
    .preview-image { width: 80px; height: 80px; object-fit: cover; border-radius: 5px; }
  </style>
</head>
<body>
  <header class="green-header">
    <img src="logo.png" class="logo" alt="SzakiPiac logó">
    <nav>
      <a href="index.html">Főoldal</a>
      <a href="rolunk.html">Rólunk</a>
      <a href="kapcsolat.html">Kapcsolat</a>
      <a href="feltoltes.html" style="font-weight:bold;">Hirdetés feltöltés</a>
      <a href="auth.html">Bejelentkezés</a>
    </nav>
  </header>
  <div class="container">
    <div class="content-box">
      <h1>Hirdetés feltöltés</h1>
      <form id="feltoltesForm">
        <label>Cím:</label>
        <input type="text" id="cim" required>
        <label>Leírás:</label>
        <textarea id="leiras" rows="4" required></textarea>
        <label>Kategória:</label>
        <select id="kategoria" required>
            <option value="">Válassz kategóriát...</option>
            <option value="Építőipar">Építőipar</option>
            <option value="Villanyszerelés">Villanyszerelés</option>
            <option value="Gépészet">Gépészet</option>
            <option value="Festés">Festés</option>
            <option value="Lakberendezés">Lakberendezés</option>
            <option value="Számítástechnika">Számítástechnika</option>
            <option value="Kertépítés, karbantartás">Kertépítés, karbantartás</option>
            <option value="Egyéb">Egyéb</option>
        </select>
        <label>Telefonszám (opcionális):</label>
        <input type="tel" id="telefonszam" placeholder="+36 30 123 4567">
        <label>Ár (Ft):</label>
        <input type="number" id="ar" min="0">
        <label>Csomag:</label>
        <select id="csomagValaszto" required>
          <option value="Alap">Alap (ingyenes, 2 kép, 7 nap)</option>
          <option value="Prémium">Prémium (1990 Ft, 3 kép, 14 nap)</option>
          <option value="Extra">Extra (2990 Ft, 5 kép, 30 nap)</option>
        </select>
        <label>Képek feltöltése:</label>
        <input type="file" id="kepek" accept="image/jpeg, image/png" multiple>
        <div id="image-previews"></div>
        <div id="paypal-container" style="display:none; margin-top: 20px;"></div>
        <button type="submit">Hirdetés feladása</button>
      </form>
      <div id="uzenet" style="margin-top:16px; font-weight: bold;"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://www.paypal.com/sdk/js?client-id=AW9Yc0M2H-I67Dx7boyvil9xg6LIdHcuwgFDpiKshLZx8RHoMfrPNMOrwyBRe589D0YXVk41cjG-TReu&currency=HUF"></script>
  <script>
    // ========== TELJES, MŰKÖDŐ KÓD BEÉPÍTVE ==========

    // 1. SUPABASE KAPCSOLAT
    const supaClient = supabase.createClient("https://yvoipikqffeipmkldfdx.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2b2lwaWtxZmZlaXBta2xkZmR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3NzEzMzYsImV4cCI6MjA2ODM0NzMzNn0.o00mebj9FaHBb2YrKe8r7JN-fBEyYrnDZhlpAZO-dK0");

    document.addEventListener('DOMContentLoaded', () => {
        // 2. FEJLÉC LOGIKA
        const adminEmail = "atika.76@windowslive.com";
        const loggedInUserEmail = localStorage.getItem("loggedInUser");
        const nav = document.querySelector('.green-header nav');
        if (nav) {
            const loginLink = nav.querySelector('a[href="auth.html"]');
            if (loggedInUserEmail && loginLink) {
                loginLink.style.display = 'none';
                const userDisplay = document.createElement('div');
                userDisplay.style.cssText = 'display:flex; align-items:center; gap:15px; margin-left: auto;';
                const adminLink = loggedInUserEmail === adminEmail ? `<a href="admin.html" style="color: #fff700; text-decoration: underline; font-weight: bold;">Admin</a>` : '';
                userDisplay.innerHTML = `<span style="color: white; font-weight: bold;">${loggedInUserEmail}</span> ${adminLink} <button id="logoutBtn" class="header-logout-btn">Kijelentkezés</button>`;
                nav.appendChild(userDisplay);
                document.getElementById('logoutBtn').addEventListener('click', async () => {
                    await supaClient.auth.signOut();
                    localStorage.removeItem('loggedInUser');
                    window.location.href = 'index.html';
                });
            }
        }

        // 3. FELTÖLTÉS LOGIKA
        const feltoltesForm = document.getElementById('feltoltesForm');
        const uzenetDiv = document.getElementById('uzenet');
        const kepekInput = document.getElementById('kepek');
        const previewsContainer = document.getElementById('image-previews');
        const csomagValaszto = document.getElementById("csomagValaszto");
        const paypalContainer = document.getElementById('paypal-container');
        let fizetesSikeres = false;
        const packageLimits = { 'Alap': 2, 'Prémium': 3, 'Extra': 5 };

        function getLoggedInEmail() { return localStorage.getItem("loggedInUser") || null; }

        function handlePackageChange() {
            const email = getLoggedInEmail();
            const isAdmin = (email === adminEmail);
            const csomag = csomagValaszto.value;
            if (csomag === 'Alap' || isAdmin || !email) {
                fizetesSikeres = true;
                paypalContainer.style.display = "none";
                paypalContainer.innerHTML = "";
                return;
            }
            fizetesSikeres = false;
            paypalContainer.style.display = "block";
            paypalContainer.innerHTML = "";
            paypal.Buttons({
                createOrder: (data, actions) => actions.order.create({ purchase_units: [{ amount: { value: csomag === "Prémium" ? "1990" : "2990", currency_code: "HUF" } }] }),
                onApprove: (data, actions) => actions.order.capture().then(details => {
                    uzenetDiv.textContent = "Fizetés sikeres!";
                    uzenetDiv.style.color = "green";
                    paypalContainer.style.display = "none";
                    fizetesSikeres = true;
                })
            }).render('#paypal-container');
        }

        kepekInput.addEventListener('change', () => {
            previewsContainer.innerHTML = '';
            const limit = packageLimits[csomagValaszto.value];
            if (kepekInput.files.length > limit) {
                alert(`A kiválasztott csomaghoz maximum ${limit} képet tölthetsz fel!`);
                kepekInput.value = '';
                return;
            }
            for (const file of kepekInput.files) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.classList.add('preview-image');
                previewsContainer.appendChild(img);
            }
        });

        csomagValaszto.addEventListener('change', () => {
            kepekInput.value = '';
            previewsContainer.innerHTML = '';
            handlePackageChange();
        });
        handlePackageChange();

        feltoltesForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const { data: { user } } = await supaClient.auth.getUser();
            if (!user) {
                uzenetDiv.textContent = "A feltöltéshez be kell jelentkezned!";
                return;
            }
            if (!fizetesSikeres && user.email !== adminEmail) {
                uzenetDiv.textContent = "A fizetős csomagoknál a feltöltés előtt fizetned kell!";
                return;
            }
            uzenetDiv.textContent = "Feltöltés folyamatban, kérlek várj...";
            document.querySelector('button[type="submit"]').disabled = true;

            try {
                const imageFiles = kepekInput.files;
                const imageUrls = [];
                for (const file of imageFiles) {
                    const filePath = `${user.id}/${Date.now()}-${file.name}`;
                    const { data, error } = await supaClient.storage.from('hirdetes-kepek').upload(filePath, file);
                    if (error) throw new Error('Képfeltöltési hiba: ' + error.message);
                    const { data: { publicUrl } } = supaClient.storage.from('hirdetes-kepek').getPublicUrl(filePath);
                    imageUrls.push(publicUrl);
                }

                const csomag = csomagValaszto.value;
                const napok = csomag === 'Alap' ? 7 : (csomag === 'Prémium' ? 14 : 30);
                const lejarat = new Date();
                lejarat.setDate(lejarat.getDate() + napok);

                const { error: insertError } = await supaClient.from('hirdetesek').insert([{
                    cim: document.getElementById('cim').value,
                    leiras: document.getElementById('leiras').value,
                    kategoria: document.getElementById('kategoria').value,
                    ar: parseInt(document.getElementById('ar').value) || null,
                    telefonszam: document.getElementById('telefonszam').value || null,
                    csomag: csomag,
                    email: user.email,
                    lejárati_datum: lejarat.toISOString(),
                    kep_url_tomb: imageUrls
                }]);

                if (insertError) throw insertError;
                window.location.href = 'sikeres.html';
            } catch (error) {
                uzenetDiv.textContent = "Hiba történt: " + error.message;
                document.querySelector('button[type="submit"]').disabled = false;
            }
        });
    });
  </script>
</body>
</html>
