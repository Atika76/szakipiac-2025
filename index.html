<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SzakiPiac-2025.hu – Kétnyelvű (HU/EN)</title>

  <!-- UI / fontok -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Supabase + PayPal + image-compress -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://www.paypal.com/sdk/js?client-id=AQsaQCLj0og2wsfMoDKAqxJieD2cgXwWq5cssAJCJbO2KoYE8LGHCREyR4vMzMfKZK68qw6EY7IAxMYF&currency=HUF"></script>
  <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2/dist/browser-image-compression.js"></script>

  <style>
    :root { --brand-yellow:#F7B500; --brand-blue:#1e64c8; --brand-red:#e11d21; }
    body{font-family:Inter,system-ui,Arial,Helvetica,sans-serif;background:#f7fafc}
    .page-content{display:none}
    .loader{width:40px;height:40px;border-radius:9999px;border:4px solid #eee;border-top-color:#2d3748;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .lang-btn{padding:6px 10px;border-radius:8px;font-weight:700}
    .lang-active{background:#e5e7eb}
    /* Banner „képek” – HTML-ből kirajzolva */
    .promo-tile{background:var(--brand-yellow);border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.08)}
    .promo-icon{filter: drop-shadow(0 3px 6px rgba(0,0,0,.15))}
  </style>
</head>
<body class="text-gray-800">

  <!-- NAV -->
  <header class="bg-white shadow-md sticky top-0 z-50">
    <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <a href="#home" class="nav-link-logo flex items-center gap-2 font-extrabold text-xl">
          <img class="h-8 w-8" src="icon-192.png" alt="SzakiPiac logó">
          <span>SzakiPiac-2025.hu</span>
        </a>

        <div class="hidden md:flex items-center gap-1">
          <a href="#home" class="nav-link px-3 py-2 rounded-md text-sm font-medium" data-i18n="nav.home">Főoldal</a>
          <a href="#rolunk" class="nav-link px-3 py-2 rounded-md text-sm font-medium" data-i18n="nav.about">Rólunk</a>
          <a href="#kapcsolat" class="nav-link px-3 py-2 rounded-md text-sm font-medium" data-i18n="nav.contact">Kapcsolat</a>
          <a href="#feltoltes" class="nav-link px-3 py-2 rounded-md text-sm font-medium bg-green-600 text-white" data-i18n="nav.post">Hirdetés feltöltése</a>
        </div>

        <div class="flex items-center gap-2">
          <div class="hidden md:flex items-center gap-1">
            <button id="lang-hu" class="lang-btn">HU</button>
            <button id="lang-en" class="lang-btn">EN</button>
          </div>
          <div id="nav-auth-section" class="hidden md:block"></div>

          <button id="mobile-menu-button" class="md:hidden p-2 text-gray-600">
            <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
          </button>
        </div>
      </div>

      <div id="mobile-menu" class="md:hidden hidden">
        <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
          <a href="#home" class="nav-link block px-3 py-2 rounded-md" data-i18n="nav.home">Főoldal</a>
          <a href="#rolunk" class="nav-link block px-3 py-2 rounded-md" data-i18n="nav.about">Rólunk</a>
          <a href="#kapcsolat" class="nav-link block px-3 py-2 rounded-md" data-i18n="nav.contact">Kapcsolat</a>
          <a href="#feltoltes" class="nav-link block px-3 py-2 rounded-md bg-green-600 text-white" data-i18n="nav.post">Hirdetés feltöltése</a>
          <div class="pt-4 mt-4 border-t flex items-center gap-2">
            <button id="lang-hu-m" class="lang-btn">HU</button>
            <button id="lang-en-m" class="lang-btn">EN</button>
          </div>
          <div id="mobile-nav-auth-section" class="pt-4 mt-4 border-t"></div>
        </div>
      </div>
    </nav>
  </header>

  <!-- MAIN -->
  <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div id="main-loader" class="page-content flex justify-center items-center py-20" style="display:none">
      <div class="loader"></div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <div class="lg:col-span-2">
        <div id="home-page" class="page-content"></div>
        <div id="rolunk-page" class="page-content"></div>
        <div id="kapcsolat-page" class="page-content"></div>
        <div id="feltoltes-page" class="page-content"></div>
        <div id="auth-page" class="page-content"></div>
        <div id="admin-page" class="page-content"></div>
      </div>

      <!-- Sidebar reklám slider (nyelvfüggő HTML-kártyákkal is) -->
      <aside class="hidden lg:block space-y-6">
        <div class="bg-white p-6 rounded-lg shadow-sm">
          <h3 class="text-lg font-semibold text-center mb-4" data-i18n="ads.title">Partnereink és ajánlataink</h3>
          <div id="reklam-slider" class="relative overflow-hidden rounded-lg shadow-md" style="height: 260px;">
            <div id="reklam-slides"></div>
            <div id="reklam-dots" class="absolute bottom-2 left-1/2 -translate-x-1/2 flex gap-2"></div>
            <button id="slider-prev" class="absolute top-1/2 left-2 -translate-y-1/2 bg-white/80 p-2 rounded-full shadow z-10" aria-label="Prev">
              <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 19l-7-7 7-7"/></svg>
            </button>
            <button id="slider-next" class="absolute top-1/2 right-2 -translate-y-1/2 bg-white/80 p-2 rounded-full shadow z-10" aria-label="Next">
              <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5l7 7-7 7"/></svg>
            </button>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Lightbox -->
  <div id="lightbox" class="fixed inset-0 bg-black/75 z-[100] hidden items-center justify-center opacity-0 transition">
    <span id="lightbox-close" class="absolute top-4 right-6 text-white text-5xl font-bold cursor-pointer">&times;</span>
    <img id="lightbox-img" class="max-w-[90%] max-h-[85%] rounded-lg">
  </div>

  <!-- Toast -->
  <div id="toast-notification" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-x-[120%] transition duration-300 z-[110]"></div>

<script>
/* =====================
   I18N szótár (HU/EN)
   ===================== */
const I18N = {
  hu: {
    nav:{home:"Főoldal",about:"Rólunk",contact:"Kapcsolat",post:"Hirdetés feltöltése"},
    hero:{title:'Üdvözlünk a <span class="text-green-600">SzakiPiac-2025.hu</span>-n!',subtitle:"Találj megbízható szakembert, vagy hirdess és szerezz új ügyfeleket!"},
    home:{searchPh:"Keresés szakmára vagy névre...",allCat:"Összes kategória",browseTitle:"Böngéssz a hirdetések között",noAds:"Jelenleg nincsenek aktív hirdetések. Legyél te az első!",email:"Kapcsolat (Email)",phone:"Kapcsolat (Telefon)",website:"Weboldal",priceAgree:"Megegyezés szerint"},
    about:{title:"Rólunk",p1:"A <b>SzakiPiac-2025.hu</b> célja, hogy összekösse a szakembereket és a megrendelőket Magyarország egész területén – egyszerűen, gyorsan, megbízhatóan.",why:"Miért válassz minket?",bullets1:"Közvetlen elérés: Regisztrált szakik, értékelésekkel.",bullets2:"Átlátható, rendezett piactér.",bullets3:"Gyors keresés kategória és kulcsszó alapján.",bullets4:"Ingyenes és fizetős hirdetés csomagok mindenkinek.",bullets5:"Egyszerű hirdetésfeltöltés és ügyfélkapcsolat.",mission:"<b>Küldetésünk:</b> Minőségi munkák, elégedett ügyfelek – támogatjuk a magyar vállalkozókat, és segítünk, hogy mindenki megtalálja a legjobb szakembert bármilyen feladathoz!"},
    contact:{title:"Kapcsolat",reach:"Elérhetőségeink:",email:"E-mail:",writeUs:"Írj nekünk!",name:"Név:",emailField:"E-mail cím:",msg:"Üzenet:",send:"Üzenet elküldése",thanks:"Köszönjük az üzenetet! (Ez egy demo.)"},
    auth:{login:"Bejelentkezés",register:"Regisztráció",email:"Email cím",pass:"Jelszó",ctaLogin:"Bejelentkezés",ctaRegister:"Regisztráció",switchToReg:"Nincs még fiókod? Regisztrálj!",switchToLogin:"Van már fiókod? Jelentkezz be!",already:"Már be vagy jelentkezve."},
    upload:{needLoginBoxTitle:"A hirdetés feladásához bejelentkezés szükséges!",needLoginBoxText:"Jelentkezz be vagy regisztrálj, hogy te is hirdethess a szakemberek között.",needLoginLink:"Kattints ide a bejelentkezéshez!",title:"Hirdetés feltöltése",subtitle:"Töltsd ki az űrlapot, vagy használd az AI segédet!",aiTitle:"✨ AI Hirdetés Segéd",aiPh:"Kulcsszavak, pl. 'szobafestés, Budapest'",aiBtn:"Szöveg generálása",fTitle:"Cím",fDesc:"Leírás",fCat:"Kategória",choose:"Válassz...",phone:"Telefonszám (opcionális)",web:"Saját weboldal (opcionális)",yt:"YouTube videó link (opcionális)",price:"Ár (Ft, opcionális)",pkg:"Csomag",pkgBasic:"Alap (ingyenes, 2 kép)",pkgPrem:"Prémium (1990 Ft, 4 kép)",pkgExtra:"Extra (2990 Ft, 8 kép)",pkgContent:"A választott csomag tartalma:",imgs:"Képek",filesPick:"Fájlok kiválasztása...",submitFree:"Hirdetés feladása",optimizing:"Képek optimalizálása... Kis türelmet.",imgsMax:"Maximum {max} képet tölthetsz fel.",needLogin:"A hirdetés feladásához be kell jelentkezned!",uploading:"Feltöltés folyamatban...",needTitleDesc:"A Cím és Leírás mezők kitöltése kötelező!",imgErr:"Hiba a képek optimalizálása során.",payErr:"Hiba a PayPal fizetés során.",genOk:"Sikeres generálás!",genErr:"Hiba a generálás során: ",adSaved:"Hirdetés sikeresen feladva!",logoutOk:"Sikeres kijelentkezés!"},
    ads:{title:"Partnereink és ajánlataink"},
    admin:{noPerm:"Nincs jogosultságod az oldal megtekintéséhez.",title:"Adminisztráció - Hirdetések kezelése",headTitle:"Cím",headUser:"Felhasználó",headExp:"Lejárat",headAct:"Műveletek",del:"Törlés",listErr:"Hiba a hirdetések betöltésekor: ",delConfirm:"Biztosan törölni szeretnéd ezt a hirdetést? Ez a művelet nem vonható vissza.",delOk:"Hirdetés sikeresen törölve."},
    misc:{pkgFeatures:{alap:["2 kép feltöltése","7 napig aktív"],premium:["4 kép feltöltése","14 napig aktív","✅ Videó beágyazás YouTube-ról"],extra:["8 kép feltöltése","30 napig aktív","✅ Videó beágyazás YouTube-ról","⭐ Kiemelt megjelenés"]},extraBadge:"EXTRA"}
  },
  en: {
    nav:{home:"Home",about:"About",contact:"Contact",post:"Post an Ad"},
    hero:{title:'Welcome to <span class="text-green-600">SzakiPiac-2025.hu</span>!',subtitle:"Find trusted pros or post an ad and get new clients!"},
    home:{searchPh:"Search by trade or name...",allCat:"All categories",browseTitle:"Browse listings",noAds:"There are no active listings yet. Be the first!",email:"Contact (Email)",phone:"Contact (Phone)",website:"Website",priceAgree:"Negotiable"},
    about:{title:"About",p1:"<b>SzakiPiac-2025.hu</b> connects customers and professionals across Hungary – simply, quickly and reliably.",why:"Why choose us?",bullets1:"Direct access: verified pros with ratings.",bullets2:"Clear, organized marketplace.",bullets3:"Fast search by category and keyword.",bullets4:"Free and paid listing packages for everyone.",bullets5:"Easy posting and client contact.",mission:"<b>Our mission:</b> Quality work and satisfied clients – we support local businesses so everyone can find the best pro for any job!"},
    contact:{title:"Contact",reach:"Our contacts:",email:"Email:",writeUs:"Write to us!",name:"Name:",emailField:"Email address:",msg:"Message:",send:"Send message",thanks:"Thanks for your message! (Demo.)"},
    auth:{login:"Sign in",register:"Sign up",email:"Email",pass:"Password",ctaLogin:"Sign in",ctaRegister:"Sign up",switchToReg:"No account yet? Register!",switchToLogin:"Already have an account? Sign in!",already:"You are already signed in."},
    upload:{needLoginBoxTitle:"You must sign in to post an ad!",needLoginBoxText:"Sign in or register to post among professionals.",needLoginLink:"Click here to sign in!",title:"Post an Ad",subtitle:"Fill the form or use the AI helper!",aiTitle:"✨ AI Ad Helper",aiPh:"Keywords, e.g. 'painter, Budapest'",aiBtn:"Generate text",fTitle:"Title",fDesc:"Description",fCat:"Category",choose:"Choose...",phone:"Phone (optional)",web:"Website (optional)",yt:"YouTube video link (optional)",price:"Price (HUF, optional)",pkg:"Package",pkgBasic:"Basic (free, 2 images)",pkgPrem:"Premium (1990 HUF, 4 images)",pkgExtra:"Extra (2990 HUF, 8 images)",pkgContent:"Selected package includes:",imgs:"Images",filesPick:"Choose files...",submitFree:"Submit ad",optimizing:"Optimizing images... Please wait.",imgsMax:"You can upload max {max} images.",needLogin:"You must sign in to post!",uploading:"Uploading...",needTitleDesc:"Title and Description are required!",imgErr:"Error while optimizing images.",payErr:"An error occurred during PayPal payment.",genOk:"Generated successfully!",genErr:"Error while generating: ",adSaved:"Ad posted successfully!",logoutOk:"Signed out successfully!"},
    ads:{title:"Partners & offers"},
    admin:{noPerm:"You don't have permission to view this page.",title:"Administration - Manage Listings",headTitle:"Title",headUser:"User",headExp:"Expires",headAct:"Actions",del:"Delete",listErr:"Error loading listings: ",delConfirm:"Are you sure you want to delete this ad? This cannot be undone.",delOk:"Ad deleted successfully."},
    misc:{pkgFeatures:{alap:["Upload 2 images","Active for 7 days"],premium:["Upload 4 images","Active for 14 days","✅ YouTube video embed"],extra:["Upload 8 images","Active for 30 days","✅ YouTube video embed","⭐ Highlighted"]},extraBadge:"EXTRA"}
  }
};

let currentLang = localStorage.getItem("szakipiac_lang") || "hu";
function t(path){return path.split(".").reduce((o,k)=>o?.[k],I18N[currentLang]) ?? path}
function setLang(lang){
  currentLang = lang; localStorage.setItem("szakipiac_lang", lang);
  document.documentElement.lang = lang === "hu" ? "hu" : "en";
  document.querySelectorAll("[data-i18n]").forEach(el => el.innerHTML = t(el.dataset.i18n));
  // Újrarender: hogy a „képes” HTML-bannerek is forduljanak
  handleRouteChange();
  document.querySelectorAll("#lang-hu, #lang-en, #lang-hu-m, #lang-en-m").forEach(b=>b?.classList.remove("lang-active"));
  (document.getElementById(lang==='hu'?'lang-hu':'lang-en'))?.classList.add("lang-active");
  (document.getElementById(lang==='hu'?'lang-hu-m':'lang-en-m'))?.classList.add("lang-active");
}

/* =========================
   „Képes” HTML bannerek
   ========================= */
// Főoldali promo – a régi bitmap helyett
function getPromoHtml(){
  const hu = `
    <div class="promo-tile p-6 sm:p-8">
      <div class="flex items-center gap-4 sm:gap-6">
        <img class="promo-icon w-16 sm:w-20" src="icon-192.png" alt="">
        <div>
          <div class="text-2xl sm:text-3xl font-extrabold tracking-tight">SzakiPiac<span class="text-black">-2025</span><span class="text-[var(--brand-red)]">.hu</span></div>
          <div class="text-lg sm:text-xl font-semibold text-[var(--brand-blue)]">Hirdess, találj, dolgozz!</div>
        </div>
      </div>
      <div class="mt-5 grid grid-cols-2 gap-4 text-sm sm:text-base">
        <div class="bg-white/80 rounded-xl p-3 shadow"><span class="font-bold">✔</span> Gyors feltöltés</div>
        <div class="bg-white/80 rounded-xl p-3 shadow"><span class="font-bold">✔</span> Megbízható szakik</div>
        <div class="bg-white/80 rounded-xl p-3 shadow"><span class="font-bold">✔</span> Kategória + kulcsszó</div>
        <div class="bg-white/80 rounded-xl p-3 shadow"><span class="font-bold">✔</span> Ingyenes csomag is</div>
      </div>
    </div>`;
  const en = `
    <div class="promo-tile p-6 sm:p-8">
      <div class="flex items-center gap-4 sm:gap-6">
        <img class="promo-icon w-16 sm:w-20" src="icon-192.png" alt="">
        <div>
          <div class="text-2xl sm:text-3xl font-extrabold tracking-tight">SzakiPiac<span class="text-black">-2025</span><span class="text-[var(--brand-red)]">.hu</span></div>
          <div class="text-lg sm:text-xl font-semibold text-[var(--brand-blue)]">Advertise, find, get to work!</div>
        </div>
      </div>
      <div class="mt-5 grid grid-cols-2 gap-4 text-sm sm:text-base">
        <div class="bg-white/80 rounded-xl p-3 shadow"><span class="font-bold">✔</span> Fast posting</div>
        <div class="bg-white/80 rounded-xl p-3 shadow"><span class="font-bold">✔</span> Trusted pros</div>
        <div class="bg-white/80 rounded-xl p-3 shadow"><span class="font-bold">✔</span> Category + keyword</div>
        <div class="bg-white/80 rounded-xl p-3 shadow"><span class="font-bold">✔</span> Free plan available</div>
      </div>
    </div>`;
  return currentLang==='hu'?hu:en;
}

// Megafonos CTA – sliderbe is betehető
function getMegaphoneHtml(){
  const hu = `
    <a href="#feltoltes" class="block w-full h-[250px] promo-tile p-6 hover:brightness-105 transition">
      <div class="flex items-start gap-4">
        <svg class="promo-icon w-16 h-16" viewBox="0 0 24 24" fill="none" stroke="#1e64c8" stroke-width="1.5">
          <path d="M3 11l16-5v12L3 13v-2Z"/><path d="M11 14c0 3-1 5-3 5s-3-2-3-5"/>
        </svg>
        <div>
          <div class="text-2xl font-extrabold leading-snug">Érd el több ezer érdeklődőt!</div>
          <div class="text-lg mt-1">Hirdess most a <span class="font-bold">SzakiPiac-2025</span><span class="text-[var(--brand-red)]">.hu</span> oldalon!</div>
        </div>
      </div>
    </a>`;
  const en = `
    <a href="#feltoltes" class="block w-full h-[250px] promo-tile p-6 hover:brightness-105 transition">
      <div class="flex items-start gap-4">
        <svg class="promo-icon w-16 h-16" viewBox="0 0 24 24" fill="none" stroke="#1e64c8" stroke-width="1.5">
          <path d="M3 11l16-5v12L3 13v-2Z"/><path d="M11 14c0 3-1 5-3 5s-3-2-3-5"/>
        </svg>
        <div>
          <div class="text-2xl font-extrabold leading-snug">Reach thousands of prospects!</div>
          <div class="text-lg mt-1">Advertise now on <span class="font-bold">SzakiPiac-2025</span><span class="text-[var(--brand-red)]">.hu</span>!</div>
        </div>
      </div>
    </a>`;
  return currentLang==='hu'?hu:en;
}

/* =========================
   Reklám slider (HTML is!)
   ========================= */
// items: {type:'html', html:fn} vagy {type:'img', url, img, alt}
function reklamosLista(){
  return [
    { type:'html', html:getPromoHtml },        // nyelvfüggő „kép”
    { type:'html', html:getMegaphoneHtml },    // nyelvfüggő „kép”
    { type:'img', url:"https://www.alza.hu/", img:"https://upload.wikimedia.org/wikipedia/commons/1/1f/Alza.cz_logo.svg", alt:"Alza.hu – Vásárolj online!" },
    { type:'img', url:"https://www.emag.hu/", img:"https://upload.wikimedia.org/wikipedia/commons/a/af/Logo_eMAG_%282019%29.svg", alt:"eMAG – Óriási választék!" },
    { type:'img', url:"https://www.temu.com/", img:"https://upload.wikimedia.org/wikipedia/commons/d/db/Temu_logo_icon.svg", alt:"Temu" }
  ];
}
let reklamIndex=0, reklamTimer=null;
function renderReklamSlide(index){
  const slides=document.getElementById("reklam-slides"); if(!slides) return;
  const items=reklamosLista(); if(!items.length) return;
  const ad=items[index];

  if(ad.type==='html'){
    slides.innerHTML = ad.html();
  }else{
    slides.innerHTML = `
      <a href="${ad.url}" target="_blank" rel="noopener sponsored" class="block w-full h-[250px]">
        <img src="${ad.img}" alt="${ad.alt||''}" class="w-full h-full object-contain p-2 bg-white rounded-md shadow">
      </a>`;
  }

  const dots=document.getElementById("reklam-dots");
  if(dots) dots.innerHTML = items.map((_,i)=>`
    <button class="w-3 h-3 rounded-full border-2 ${i===index?'bg-green-600 border-green-700':'bg-white border-gray-400'}"
            onclick="showReklamSlide(${i})" aria-label="Slide ${i+1}"></button>`).join("");
}
function showReklamSlide(i){reklamIndex=i;renderReklamSlide(reklamIndex);resetReklamTimer()}
function reklamPrev(){const items=reklamosLista();reklamIndex=(reklamIndex-1+items.length)%items.length;renderReklamSlide(reklamIndex);resetReklamTimer()}
function reklamNext(){const items=reklamosLista();reklamIndex=(reklamIndex+1)%items.length;renderReklamSlide(reklamIndex);resetReklamTimer()}
function resetReklamTimer(){if(reklamTimer)clearInterval(reklamTimer);const items=reklamosLista();if(items.length>1)reklamTimer=setInterval(reklamNext,4000)}
document.addEventListener("DOMContentLoaded",()=>{
  if(document.getElementById("reklam-slider")){
    renderReklamSlide(reklamIndex);
    document.getElementById("slider-prev")?.addEventListener("click",reklamPrev);
    document.getElementById("slider-next")?.addEventListener("click",reklamNext);
    resetReklamTimer();
  }
});

/* =========================
   App (Supabase, router, stb.)
   ========================= */
const SUPABASE_URL = "https://bxtpnotswnwrbycvfypz.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4dHBub3Rzd253cmJ5Y3ZmeXB6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MTQ0NDcsImV4cCI6MjA2ODQ5MDQ0N30.CXEfo_8qmIYhkEZFdTsbl9ZB-PRTP6UK8EbIxxpSGZc";
const supaClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const ADMIN_EMAIL = "atika.76@windowslive.com";

let kivalasztottKepek = [];
let hirdetesekCache = [];

const router = {
  '#home': showHomePage,
  '#rolunk': showRolunkPage,
  '#kapcsolat': showKapcsolatPage,
  '#feltoltes': showFeltoltesPage,
  '#auth': showAuthPage,
  '#admin': showAdminPage
};
function showPage(id){document.querySelectorAll(".page-content").forEach(p=>{if(p.id!=="main-loader")p.style.display="none"});document.getElementById(id+"-page").style.display="block"}
async function handleRouteChange(){
  const hash=window.location.hash||"#home";
  document.querySelectorAll(".page-content").forEach(p=>p.style.display="none");
  const mainLoader=document.getElementById("main-loader"); mainLoader.style.display="flex";
  const handler=router[hash]||router["#home"];
  try{await handler()}catch(e){console.error(e)}finally{mainLoader.style.display="none";showPage(hash.substring(1))}
  document.querySelectorAll(".nav-link").forEach(a=>a.classList.toggle("bg-gray-100",a.getAttribute("href")===hash));
  document.getElementById("mobile-menu").classList.add("hidden");
}

/* -------- Oldalak -------- */
async function showHomePage(){
  const el=document.getElementById("home-page");
  el.innerHTML = `
    <div class="text-center mb-8">
      <h1 class="text-4xl font-extrabold">${t('hero.title')}</h1>
      <p class="mt-3 text-lg text-gray-600">${t('hero.subtitle')}</p>
    </div>

    <!-- NYELVFÜGGŐ PROMO-BANNER (nem bitmap) -->
    <div class="mb-12">${getPromoHtml()}</div>

    <div class="bg-white p-6 rounded-lg shadow-sm mb-8">
      <h2 class="text-2xl font-bold text-center mb-4">${t('home.browseTitle')}</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <input id="search-input" class="md:col-span-2 w-full border-gray-300 rounded-md" placeholder="${t('home.searchPh')}">
        <select id="category-select" class="w-full border-gray-300 rounded-md">
          <option value="">${t('home.allCat')}</option>
          <option>Építőipar</option><option>Villanyszerelés</option><option>Gépészet</option>
          <option>Festés</option><option>Lakberendezés</option><option>Számítástechnika</option>
          <option>Kertépítés, karbantartás</option><option>Egyéb</option>
        </select>
      </div>
    </div>

    <div id="hirdetesek-lista" class="space-y-6">
      <div class="flex justify-center py-10"><div class="loader"></div></div>
    </div>`;
  el.querySelector("#search-input").addEventListener("input", szuresAlkalmazasa);
  el.querySelector("#category-select").addEventListener("change", szuresAlkalmazasa);
  await loadHirdetesek();
}

async function showRolunkPage(){
  document.getElementById("rolunk-page").innerHTML = `
    <div class="bg-white p-8 rounded-lg shadow-sm">
      <h1 class="text-3xl font-extrabold mb-6">${t('about.title')}</h1>
      <p class="mb-4 text-gray-700">${t('about.p1')}</p>
      <ul class="space-y-3 my-6">
        <li><b>✔</b> ${t('about.bullets1')}</li>
        <li><b>✔</b> ${t('about.bullets2')}</li>
        <li><b>✔</b> ${t('about.bullets3')}</li>
        <li><b>✔</b> ${t('about.bullets4')}</li>
        <li><b>✔</b> ${t('about.bullets5')}</li>
      </ul>
      <p class="mb-4 text-gray-700">${t('about.mission')}</p>
    </div>`;
}

async function showKapcsolatPage(){
  const c=document.getElementById("kapcsolat-page");
  c.innerHTML = `
    <div class="bg-white p-8 rounded-lg shadow-sm">
      <h1 class="text-3xl font-extrabold mb-6">${t('contact.title')}</h1>
      <div class="grid md:grid-cols-2 gap-12">
        <div>
          <h3 class="text-xl font-semibold">${t('contact.reach')}</h3>
          <p class="mt-4"><b>${t('contact.email')}</b> <a href="mailto:szakipiac2025@gmail.com" class="text-green-600">szakipiac2025@gmail.com</a></p>
        </div>
        <div>
          <h3 class="text-xl font-semibold mb-4">${t('contact.writeUs')}</h3>
          <form id="kapcsolat-form" class="space-y-4">
            <div><label>${t('contact.name')}</label><input id="kapcsolat-nev" class="mt-1 block w-full border-gray-300 rounded-md" required></div>
            <div><label>${t('contact.emailField')}</label><input id="kapcsolat-email" type="email" class="mt-1 block w-full border-gray-300 rounded-md" required></div>
            <div><label>${t('contact.msg')}</label><textarea id="kapcsolat-uzenet" rows="4" class="mt-1 block w-full border-gray-300 rounded-md" required></textarea></div>
            <button class="w-full bg-green-600 text-white py-2 rounded-md">${t('contact.send')}</button>
          </form>
        </div>
      </div>
    </div>`;
  c.querySelector("#kapcsolat-form").addEventListener("submit",e=>{
    e.preventDefault();showToast(t('contact.thanks'),"info");e.target.reset();
  });
}

async function showAuthPage(){
  const el=document.getElementById("auth-page");
  const { data:{ session } } = await supaClient.auth.getSession();
  if(session){
    el.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-sm text-center">
      <h1 class="text-2xl font-bold mb-4">${t('auth.already')}</h1><p class="text-gray-600">${session.user.email}</p></div>`;
    return;
  }
  el.innerHTML = `
    <div class="bg-white p-8 rounded-lg shadow-sm max-w-md mx-auto">
      <h2 id="auth-title" class="text-2xl font-bold text-center mb-6">${t('auth.login')}</h2>
      <form id="auth-form" class="space-y-6">
        <div><label class="block text-sm">${t('auth.email')}</label><input id="email" type="email" required class="mt-1 w-full border-gray-300 rounded-md"></div>
        <div><label class="block text-sm">${t('auth.pass')}</label><input id="password" type="password" required class="mt-1 w-full border-gray-300 rounded-md"></div>
        <button id="auth-submit-btn" class="w-full text-white bg-green-600 hover:bg-green-700 py-2 rounded-md">${t('auth.ctaLogin')}</button>
      </form>
      <div class="mt-6 text-center"><a href="#" id="switch-auth-mode" class="text-sm text-green-600 hover:text-green-500">${t('auth.switchToReg')}</a></div>
    </div>`;
  let isLoginMode=true;
  el.querySelector("#auth-form").addEventListener("submit",async e=>{
    e.preventDefault();const email=e.target.email.value, password=e.target.password.value;
    try{
      const { error } = isLoginMode ? await supaClient.auth.signInWithPassword({email,password})
                                    : await supaClient.auth.signUp({email,password});
      if(error) throw error;
      showToast(isLoginMode?t('upload.logoutOk'):t('upload.genOk'));
      window.location.hash="#home";
    }catch(err){showToast("Hiba: "+err.message,"error")}
  });
  el.querySelector("#switch-auth-mode").addEventListener("click",e=>{
    e.preventDefault();isLoginMode=!isLoginMode;
    el.querySelector("#auth-title").textContent=isLoginMode?t('auth.login'):t('auth.register');
    el.querySelector("#auth-submit-btn").textContent=isLoginMode?t('auth.ctaLogin'):t('auth.ctaRegister');
    e.target.textContent=isLoginMode?t('auth.switchToReg'):t('auth.switchToLogin');
  });
}

async function loadHirdetesek(){
  const list=document.getElementById("hirdetesek-lista");
  try{
    const { data, error } = await supaClient.from("hirdetesek").select("*").gte("lejárati_datum", (new Date).toISOString());
    if(error) throw error;
    const weight={extra:3,premium:2,alap:1};
    data.sort((a,b)=> (weight[b.csomag]||0)-(weight[a.csomag]||0) || (new Date(b.created_at)-new Date(a.created_at)));
    hirdetesekCache = data;
    renderHirdetesek(data);
  }catch(e){ list.innerHTML = `<p class="text-center text-red-600">Error loading listings.</p>`; }
}

async function renderHirdetesek(arr){
  const wrap=document.getElementById("hirdetesek-lista");
  const { data:{ session } } = await supaClient.auth.getSession();
  if(!arr || !arr.length){ wrap.innerHTML = `<p class="text-center text-gray-500">${t('home.noAds')}</p>`; return; }
  wrap.innerHTML = arr.map(h=>{
    const yt = getYouTubeEmbedUrl(h.video_url);
    const video = yt ? `<div class="aspect-video my-4 rounded-lg overflow-hidden shadow"><iframe src="${yt}" allowfullscreen class="w-full h-full"></iframe></div>` : "";
    const isOwner = session && session.user.id===h.user_id;
    const isAdmin = session && session.user.email===ADMIN_EMAIL;
    const delBtn = (isOwner||isAdmin) ? `<button onclick="handleDeleteAd('${h.id}')" class="px-3 py-1.5 text-sm text-white bg-red-600 rounded-md">${t('admin.del')}</button>` : "";
    const badge = h.csomag==="extra" ? `<div class="absolute top-0 right-0 -mt-3 -mr-3 bg-yellow-400 text-white text-xs font-bold px-2 py-1 rounded-full shadow">${t('misc.extraBadge')}</div>` : "";
    const imgs = (h.kep_url_tomb||[]).length ? `<div class="flex flex-wrap gap-2 mb-4">${h.kep_url_tomb.map(u=>`<img src="${u}" class="h-20 w-20 object-cover rounded-md cursor-pointer" onclick="openLightbox('${u}')">`).join("")}</div>` : "";
    const price = h.ar ? (currentLang==='hu' ? (Number(h.ar).toLocaleString("hu-HU")+" Ft")
                                            : (Number(h.ar).toLocaleString("en-US")+" HUF")) : t('home.priceAgree');
    return `
      <div class="bg-white p-6 rounded-lg shadow-sm relative ${h.csomag==='extra'?'border-2 border-yellow-400':''}">
        ${badge}
        <div class="flex justify-between items-start">
          <div>
            <p class="text-sm font-medium text-green-600">${h.kategoria||""}</p>
            <h3 class="text-xl font-bold mt-1">${h.cim}</h3>
          </div>
          <p class="text-lg font-semibold">${price}</p>
        </div>
        <p class="text-gray-600 my-4">${h.leiras}</p>
        ${video}${imgs}
        <div class="flex flex-wrap gap-2 pt-4 border-t justify-between items-center">
          <div>
            <a class="px-3 py-1.5 text-sm text-white bg-green-600 rounded-md" href="mailto:${h.email}">${t('home.email')}</a>
            ${h.telefonszam?`<a class="px-3 py-1.5 text-sm bg-gray-200 rounded-md" href="tel:${h.telefonszam}">${t('home.phone')}</a>`:""}
            ${h.weboldal?`<a class="px-3 py-1.5 text-sm text-white bg-blue-600 rounded-md" rel="noopener nofollow" target="_blank" href="${h.weboldal}">${t('home.website')}</a>`:""}
          </div>
          ${delBtn}
        </div>
      </div>`;
  }).join("");
}

function szuresAlkalmazasa(){
  const q=document.getElementById("search-input").value.toLowerCase();
  const cat=document.getElementById("category-select").value;
  renderHirdetesek(hirdetesekCache.filter(h=>{
    const mTxt=`${h.cim} ${h.leiras}`.toLowerCase().includes(q);
    const mCat=!cat || h.kategoria===cat;
    return mTxt && mCat;
  }));
}

/* ---- Feltöltés oldal (változatlan logika) ---- */
// YouTube ID
function getYouTubeEmbedUrl(url){if(!url)return null;try{const u=new URL(url);let id;if(u.hostname==="youtu.be")id=u.pathname.slice(1);else if(u.hostname.includes("youtube.com")&&u.searchParams.has("v"))id=u.searchParams.get("v");return id?`https://www.youtube.com/embed/${id}`:null}catch{return null}}

async function showFeltoltesPage(){
  const el=document.getElementById("feltoltes-page");
  const { data:{ session } } = await supaClient.auth.getSession();
  const warn = !session? `<div class="bg-blue-100 border-l-4 border-blue-500 text-blue-800 p-4 mb-6 rounded-md">
    <p class="font-bold">${t('upload.needLoginBoxTitle')}</p>
    <p>${t('upload.needLoginBoxText')} <a href="#auth" class="nav-link font-bold underline">${t('upload.needLoginLink')}</a></p>
  </div>`:``;
  kivalasztottKepek=[];
  el.innerHTML=`
    <div class="bg-white p-8 rounded-lg shadow-sm">
      ${warn}
      <h1 class="text-3xl font-extrabold mb-2">${t('upload.title')}</h1>
      <p class="text-gray-600 mb-8">${t('upload.subtitle')}</p>

      <div class="bg-indigo-50 border border-indigo-200 p-6 rounded-lg mb-8">
        <h2 class="text-xl font-semibold text-indigo-800 mb-3">${t('upload.aiTitle')}</h2>
        <div class="flex flex-col sm:flex-row gap-2">
          <input id="gemini-keywords" class="flex-grow w-full px-4 py-2 border-indigo-300 rounded-md" placeholder="${t('upload.aiPh')}">
          <button id="generate-ad-btn" class="inline-flex items-center justify-center px-4 py-2 text-sm text-white bg-indigo-600 rounded-md">${t('upload.aiBtn')}</button>
        </div>
      </div>

      <form id="feltoltesForm" class="space-y-6">
        <div><label class="block text-sm">${t('upload.fTitle')}</label><input id="cim" required class="mt-1 w-full border-gray-300 rounded-md"></div>
        <div><label class="block text-sm">${t('upload.fDesc')}</label><textarea id="leiras" rows="6" required class="mt-1 w-full border-gray-300 rounded-md"></textarea></div>

        <div class="grid md:grid-cols-2 gap-6">
          <div><label class="block text-sm">${t('upload.fCat')}</label>
            <select id="kategoria" required class="mt-1 w-full border-gray-300 rounded-md">
              <option value="">${t('upload.choose')}</option>
              <option>Építőipar</option><option>Villanyszerelés</option><option>Gépészet</option>
              <option>Festés</option><option>Lakberendezés</option><option>Számítástechnika</option>
              <option>Kertépítés, karbantartás</option><option>Egyéb</option>
            </select>
          </div>
          <div><label class="block text-sm">${t('upload.phone')}</label><input id="telefonszam" placeholder="+36..." class="mt-1 w-full border-gray-300 rounded-md"></div>
          <div><label class="block text-sm">${t('upload.web')}</label><input id="weboldal" placeholder="https://..." class="mt-1 w-full border-gray-300 rounded-md"></div>
          <div id="video-url-wrapper" class="hidden"><label class="block text-sm">${t('upload.yt')}</label><input id="video_url" placeholder="https://www.youtube.com/watch?v=..." class="mt-1 w-full border-gray-300 rounded-md"></div>
        </div>

        <div><label class="block text-sm">${t('upload.price')}</label><input id="ar" type="number" min="0" placeholder="${t('home.priceAgree')}" class="mt-1 w-full border-gray-300 rounded-md"></div>

        <div>
          <label class="block text-sm">${t('upload.pkg')}</label>
          <select id="csomag" required class="mt-1 w-full border-gray-300 rounded-md">
            <option value="alap_0_2">${t('upload.pkgBasic')}</option>
            <option value="premium_1990_4">${t('upload.pkgPrem')}</option>
            <option value="extra_2990_8">${t('upload.pkgExtra')}</option>
          </select>
        </div>

        <div id="csomag-leiras" class="mt-4 p-4 bg-gray-50 rounded-lg border text-sm"></div>

        <div>
          <label class="block text-sm">${t('upload.imgs')} (<span id="max-kepek-szama">2</span> db)</label>
          <label class="inline-block mt-1 cursor-pointer text-green-600 underline">
            ${t('upload.filesPick')} <input id="kep-input" type="file" multiple accept="image/*" class="sr-only">
          </label>
          <div id="kep-elonezetek" class="mt-4 grid grid-cols-3 sm:grid-cols-5 gap-4"></div>
        </div>

        <div id="payment-section" class="border-t pt-6">
          <div id="free-submit-section"><button id="free-submit-btn" class="w-full bg-green-600 text-white py-3 rounded-md">${t('upload.submitFree')}</button></div>
          <div id="paypal-button-container" class="hidden"></div>
        </div>
      </form>
    </div>`;
  setupFeltoltesListeners();
}

function setupFeltoltesListeners(){
  const el=document.getElementById("feltoltes-page");
  el.querySelector("#generate-ad-btn").addEventListener("click",generateAdContent);
  el.querySelector("#csomag").addEventListener("change",handleCsomagValtas);
  el.querySelector("#kep-input").addEventListener("change",handleKepKivalasztas);
  el.querySelector("#free-submit-btn").addEventListener("click",(e)=>{e.preventDefault();processAdSubmission()});
  handleCsomagValtas();
}

async function handleCsomagValtas(){
  const cs=document.getElementById("csomag");
  const [pkg,price,maxImgs]=cs.value.split("_");
  document.getElementById("max-kepek-szama").textContent=maxImgs;
  if(kivalasztottKepek.length>maxImgs){kivalasztottKepek=kivalasztottKepek.slice(0,maxImgs);renderKepElonezetek();showToast(currentLang==='hu'?`A képek száma ${maxImgs} darabra korlátozva.`:`Image limit is ${maxImgs}.`,"info")}
  const videoWrap=document.getElementById("video-url-wrapper"), pkgBox=document.getElementById("csomag-leiras");
  const feats = (t('misc.pkgFeatures')[pkg]) || [];
  pkgBox.innerHTML = `<h4 class="font-semibold mb-2">${t('upload.pkgContent')}</h4><ul class="list-disc list-inside space-y-1 text-gray-600">${feats.map(f=>`<li>${f}</li>`).join("")}</ul>`;
  if(pkg==="premium"||pkg==="extra") videoWrap.classList.remove("hidden"); else { videoWrap.classList.add("hidden"); document.getElementById("video_url").value="" }
  const { data:{ session } } = await supaClient.auth.getSession();
  const isAdmin = session && session.user.email===ADMIN_EMAIL;
  const freeSec=document.getElementById("free-submit-section"), pp=document.getElementById("paypal-button-container");
  if(isAdmin || price==0){ freeSec.style.display="block"; pp.style.display="none"; pp.innerHTML="" }
  else{ freeSec.style.display="none"; pp.style.display="block"; pp.innerHTML=""; renderPayPalButton(price,pkg) }
}

async function handleKepKivalasztas(e){
  const files=[...e.target.files]; const max=parseInt(document.getElementById("max-kepek-szama").textContent);
  if(kivalasztottKepek.length+files.length>max){showToast(t('upload.imgsMax').replace('{max}',max),'error'); e.target.value=''; return}
  showToast(t('upload.optimizing'),'info');
  const opts={maxSizeMB:1,maxWidthOrHeight:1280,useWebWorker:true};
  try{
    for(const f of files){ kivalasztottKepek.push(await imageCompression(f,opts)) }
    e.target.value=''; renderKepElonezetek();
  }catch{ showToast(t('upload.imgErr'),'error') }
}
function renderKepElonezetek(){
  const box=document.getElementById("kep-elonezetek"); box.innerHTML='';
  kivalasztottKepek.forEach((file,i)=>{
    const r=new FileReader(); r.onload=ev=>{
      const w=document.createElement('div'); w.className="relative group";
      w.innerHTML=`<img src="${ev.target.result}" class="w-full h-24 object-cover rounded-md border">
                   <button type="button" class="absolute -top-2 -right-2 h-6 w-6 rounded-full bg-red-600 text-white font-bold opacity-0 group-hover:opacity-100" onclick="kepTorlese(${i})">×</button>`;
      box.appendChild(w);
    }; r.readAsDataURL(file);
  });
}
function kepTorlese(i){kivalasztottKepek.splice(i,1);renderKepElonezetek()}

async function processAdSubmission(){
  const { data:{ session } } = await supaClient.auth.getSession();
  if(!session){showToast(t('upload.needLogin'),'error');return}
  const ad=getAdData(); if(!ad) return;
  showToast(t('upload.uploading'),'info');
  try{
    const urls=await uploadKepek(kivalasztottKepek);
    await saveAdToDatabase(ad,urls);
  }catch(e){showToast(`Hiba történt: ${e.message}`,'error')}
}
function getAdData(){
  const cim=document.getElementById("cim").value, leiras=document.getElementById("leiras").value;
  if(!cim||!leiras){showToast(t('upload.needTitleDesc'),'error');return null}
  return {cim,leiras,kategoria:document.getElementById("kategoria").value,ar:document.getElementById("ar").value||null,telefonszam:document.getElementById("telefonszam").value||null,weboldal:document.getElementById("weboldal").value||null,video_url:document.getElementById("video_url").value||null}
}
async function uploadKepek(files){
  const { data:{ session } } = await supaClient.auth.getSession(); if(!session || !files.length) return [];
  const ups = await Promise.all(files.map(f=>supaClient.storage.from("hirdetes-kepek").upload(`${session.user.id}/${Date.now()}_${f.name}`,f)));
  const urls=[]; for(const r of ups){ if(r.error) throw r.error; const { data } = supaClient.storage.from("hirdetes-kepek").getPublicUrl(r.data.path); urls.push(data.publicUrl) }
  return urls;
}
async function saveAdToDatabase(ad,urls){
  const { data:{ session } } = await supaClient.auth.getSession(); if(!session){showToast("Not signed in","error");return}
  const pkg=document.getElementById("csomag").value.split("_")[0];
  const days={alap:7,premium:14,extra:30}[pkg]||7;
  const exp=new Date(); exp.setDate(exp.getDate()+days);
  const { error } = await supaClient.from("hirdetesek").insert({...ad,user_id:session.user.id,email:session.user.email,csomag:pkg,kep_url_tomb:urls,lejárati_datum:exp.toISOString()});
  if(error){showToast(`Hiba a mentéskor: ${error.message}`,'error')} else {showToast(t('upload.adSaved'),'success');window.location.hash="#home"}
}
function renderPayPalButton(price,packageName){
  paypal.Buttons({
    createOrder:(d,a)=>{ if(!getAdData()) return Promise.reject(new Error("invalid")); return a.order.create({purchase_units:[{description:`SzakiPiac package: ${packageName}`,amount:{currency_code:"HUF",value:price}}]})},
    onApprove:(d,a)=>a.order.capture().then(()=>processAdSubmission()),
    onError:(e)=>showToast(t('upload.payErr'),'error')
  }).render("#paypal-button-container")
}
async function generateAdContent(){
  const kw=document.getElementById("gemini-keywords").value.trim();
  if(!kw){showToast(currentLang==='hu'?"Kérlek, adj meg kulcsszavakat!":"Please add some keywords!","error");return}
  const btn=document.getElementById("generate-ad-btn"); const old=btn.textContent; btn.disabled=true; btn.textContent=currentLang==='hu'?"Generálás...":"Generating...";
  try{
    const { data, error } = await supaClient.functions.invoke("generate-ad",{body:{keywords:kw}});
    if(error) throw new Error(error.message||"Function error");
    document.getElementById("cim").value=data.cim; document.getElementById("leiras").value=data.leiras;
    showToast(t('upload.genOk'),'success');
  }catch(e){showToast(t('upload.genErr')+e.message,'error')}
  finally{btn.disabled=false; btn.textContent=old}
}

/* ---- Auth UI + segéd ---- */
async function handleAuthUI(){
  const { data:{ session } } = await supaClient.auth.getSession();
  const nav=document.getElementById("nav-auth-section");
  const mnav=document.getElementById("mobile-nav-auth-section");
  let html="";
  if(session){
    const admin=session.user.email===ADMIN_EMAIL;
    html=`<div class="flex items-center gap-4"><span class="text-sm hidden lg:inline">${session.user.email}</span>${admin?`<a href="#admin" class="text-sm font-medium text-yellow-600">Admin</a>`:""}<button id="logoutBtn" class="text-sm font-medium">${currentLang==='hu'?'Kijelentkezés':'Sign out'}</button></div>`;
  }else{
    html=`<a href="#auth" class="text-base font-medium text-gray-500 hover:text-gray-900">${currentLang==='hu'?'Bejelentkezés':'Sign in'}</a>`;
  }
  nav.innerHTML=html; mnav.innerHTML=html.replace("hidden lg:inline","");
  if(session) document.querySelectorAll("#logoutBtn").forEach(b=>b.addEventListener("click",async()=>{await supaClient.auth.signOut();showToast(t('upload.logoutOk'));window.location.hash="#home"}));
}
function showToast(msg,type="success"){
  const el=document.getElementById("toast-notification");
  el.textContent=msg; el.className=`fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transform transition duration-300 z-[110] ${type==='error'?'bg-red-500':'bg-green-500'}`;
  el.classList.remove("translate-x-[120%]"); setTimeout(()=>el.classList.add("translate-x-[120%]"),4000);
}

/* ---- Egyéb: lightbox, törlés, admin ---- */
window.openLightbox=(url)=>{const lb=document.getElementById("lightbox");document.getElementById("lightbox-img").src=url;lb.classList.remove("hidden");setTimeout(()=>lb.classList.remove("opacity-0"),10)};
document.getElementById("lightbox-close").addEventListener("click",()=>{const lb=document.getElementById("lightbox");lb.classList.add("opacity-0");setTimeout(()=>lb.classList.add("hidden"),300)});

async function handleDeleteAd(id){
  if(!confirm(t('admin.delConfirm'))) return;
  try{
    const { data:ad, error:selErr } = await supaClient.from("hirdetesek").select("kep_url_tomb").eq("id",id).single();
    if(selErr) throw selErr;
    if(ad?.kep_url_tomb?.length){
      const files=ad.kep_url_tomb.map(u=>(new URL(u)).pathname.split("/hirdetes-kepek/")[1]);
      const { error:remErr } = await supaClient.storage.from("hirdetes-kepek").remove(files);
      if(remErr) console.warn("Image delete warning:",remErr.message);
    }
    const { error:delErr } = await supaClient.from("hirdetesek").delete().eq("id",id);
    if(delErr) throw delErr;
    showToast(t('admin.delOk'),'success'); loadHirdetesek();
  }catch(e){showToast('Hiba: '+e.message,'error')}
}
async function showAdminPage(){
  const el=document.getElementById("admin-page"); el.innerHTML=`<div class="flex justify-center py-10"><div class="loader"></div></div>`;
  const { data:{ session } } = await supaClient.auth.getSession();
  if(!session || session.user.email!==ADMIN_EMAIL){ el.innerHTML=`<p class="text-red-500 text-center">${t('admin.noPerm')}</p>`; return }
  try{
    const { data:list, error } = await supaClient.from("hirdetesek").select("*").order("created_at",{ascending:false});
    if(error) throw error;
    el.innerHTML = `
      <h2 class="text-2xl font-extrabold mb-4">${t('admin.title')}</h2>
      <div class="bg-white rounded-lg shadow-sm overflow-x-auto">
        <table class="w-full text-sm text-left">
          <thead class="bg-gray-50"><tr>
            <th class="p-4">${t('admin.headTitle')}</th>
            <th class="p-4">${t('admin.headUser')}</th>
            <th class="p-4">${t('admin.headExp')}</th>
            <th class="p-4">${t('admin.headAct')}</th>
          </tr></thead>
          <tbody>
            ${list.map(h=>`<tr class="border-b">
              <td class="p-4">${h.cim}</td>
              <td class="p-4">${h.email}</td>
              <td class="p-4 whitespace-nowrap">${h.lejárati_datum?(new Date(h.lejárati_datum)).toLocaleDateString(currentLang==='hu'?'hu-HU':'en-GB'):'N/A'}</td>
              <td class="p-4"><button onclick="handleDeleteAd('${h.id}')" class="text-red-600 hover:underline">${t('admin.del')}</button></td>
            </tr>`).join("")}
          </tbody>
        </table>
      </div>`;
  }catch(e){ el.innerHTML=`<p class="text-red-500 text-center">${t('admin.listErr')}${e.message}</p>` }
}

/* ---- Init ---- */
document.addEventListener("DOMContentLoaded",()=>{
  setLang(currentLang);
  document.querySelectorAll("[data-i18n]").forEach(el=>el.innerHTML=t(el.dataset.i18n));
  const bind=(id,lang)=>document.getElementById(id)?.addEventListener("click",()=>setLang(lang));
  bind("lang-hu","hu"); bind("lang-en","en"); bind("lang-hu-m","hu"); bind("lang-en-m","en");

  handleAuthUI();
  handleRouteChange();
  window.addEventListener("hashchange",handleRouteChange);

  document.querySelectorAll(".nav-link, .nav-link-logo").forEach(a=>{
    a.addEventListener("click",e=>{e.preventDefault();window.location.hash=(new URL(a.href)).hash})
  });
  document.getElementById("mobile-menu-button").addEventListener("click",()=>document.getElementById("mobile-menu").classList.toggle("hidden"));
  supaClient.auth.onAuthStateChange(()=>{handleAuthUI();handleRouteChange()});
});
</script>
</body>
</html>
