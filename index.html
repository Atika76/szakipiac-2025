<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SzakiPiac — Főoldal</title>
  <link rel="stylesheet" href="style.css">
  <meta name="description" content="SzakiPiac — hirdetések helyi szakemberektől. Feladni csak regisztráció után lehet.">
</head>
<body>
  <!-- header.js beszúrja a fejlécet -->
  <div class="page-wrap">
    <main class="site-main container">
      <section class="hero">
        <h1>SzakiPiac</h1>
        <p>Találd meg a helyi szakembert gyorsan — vagy add fel hirdetésed néhány kattintással!</p>
        <div class="hero-actions">
          <a class="btn" href="feltoltes.html">Hirdetés feladása</a>
          <a class="btn outline" href="auth.html">Bejelentkezés / Regisztráció</a>
        </div>
      </section>

      <section class="content">
        <div class="ads-column">
          <h2>Friss, jóváhagyott hirdetések</h2>
          <div id="ads-list" class="ads-list">
            <p class="muted">Hirdetések betöltése…</p>
          </div>
        </div>

        <aside class="sidebar">
          <div class="ad-box">
            <h3>Reklámsáv</h3>
            <a href="https://example.com" target="_blank" rel="noopener">
              <img src="reklam1.png" alt="Reklám" style="width:100%;height:auto;">
            </a>
          </div>

          <div class="info-box">
            <h4>Tippek a jobb hirdetésért</h4>
            <ul>
              <li>Jól látható címet adj meg.</li>
              <li>Tüntesd fel a pontos árat és rövid leírást.</li>
              <li>Tölts fel min. 1-2 képet — a több kattintást hoz.</li>
            </ul>
          </div>
        </aside>
      </section>
    </main>
  </div>

  <!-- Footernél betöltjük a közös js-eket -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="supabase.js"></script>
  <script src="header.js"></script>

  <script>
    // index.html: betölti a jóváhagyott hirdetéseket és megjeleníti őket
    async function fetchApprovedAds() {
      const adsList = document.getElementById('ads-list');
      adsList.innerHTML = '<p class="muted">Hirdetések betöltése…</p>';

      try {
        // csak a jóváhagyottakat kérjük le
        const { data, error } = await supabase
          .from('hirdetesek')
          .select('id, cim, leiras, ar, kategoria, csomag, kepek, created_at')
          .eq('jovahagyott', true)
          .order('created_at', { ascending: false })
          .limit(100);

        if (error) throw error;

        if (!data || data.length === 0) {
          adsList.innerHTML = '<p class="muted">Jelenleg nincs megjeleníthető hirdetés.</p>';
          return;
        }

        adsList.innerHTML = data.map(renderAdCard).join('');
      } catch (err) {
        console.error('Hiba a hirdetések lekérésekor:', err);
        adsList.innerHTML = '<p class="error">Nem sikerült betölteni a hirdetéseket. Próbáld újra később.</p>';
      }
    }

    function shorten(text, max = 180) {
      if (!text) return '';
      return text.length > max ? text.slice(0, max).trim() + '…' : text;
    }

    function renderAdCard(ad) {
      const images = Array.isArray(ad.kepek) ? ad.kepek : (ad.kepek ? [ad.kepek] : []);
      const imgTag = images.length
        ? `<div class="thumb"><img src="${escapeHtml(images[0])}" alt="${escapeHtml(ad.cim || 'Hirdetés kép')}"></div>`
        : '<div class="thumb placeholder">Nincs kép</div>';

      return `
        <article class="ad-card" data-id="${ad.id}">
          ${imgTag}
          <div class="ad-body">
            <h3 class="ad-title">${escapeHtml(ad.cim || 'Névtelen hirdetés')}</h3>
            <p class="ad-meta">${escapeHtml(ad.kategoria || '')} • <strong>${escapeHtml(ad.csomag || '')}</strong></p>
            <p class="ad-desc">${escapeHtml(shorten(ad.leiras || 'Nincs leírás', 220))}</p>
            <div class="ad-bottom">
              <div class="price">${ad.ar ? escapeHtml(ad.ar + ' Ft') : 'Ár egyeztetés'}</div>
              <a class="btn small" href="hirdetes.html?id=${ad.id}">Részletek</a>
            </div>
          </div>
        </article>
      `;
    }

    // egyszerű HTML escape (image url-eket, szöveget is biztonságosan megjelenít)
    function escapeHtml(s) {
      if (s === null || s === undefined) return '';
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    // When DOM ready
    document.addEventListener('DOMContentLoaded', () => {
      fetchApprovedAds();
    });
  </script>

  <style>
    /* Kicsi, beágyazott alapstílus, ha nincs style.css vagy gyors ellenőrzéshez */
    :root{--green:#2d8532;--muted:#666}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;line-height:1.45;margin:0;background:#f6f6f7;color:#222}
    .container{max-width:1100px;margin:0 auto;padding:18px}
    .hero{background:#fff;padding:18px;border-radius:8px;margin-bottom:14px;box-shadow:0 1px 4px rgba(0,0,0,.04)}
    .hero h1{margin:0 0 .3rem}
    .hero-actions{margin-top:10px}
    .btn{background:var(--green);color:#fff;padding:10px 14px;border-radius:8px;text-decoration:none;display:inline-block}
    .btn.outline{background:transparent;border:1px solid var(--green);color:var(--green)}
    .content{display:flex;gap:20px;align-items:flex-start}
    .ads-column{flex:1}
    .sidebar{width:300px}
    .ads-list{display:flex;flex-direction:column;gap:12px}
    .ad-card{display:flex;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .ad-card .thumb{width:160px;height:120px;flex:0 0 160px;display:flex;align-items:center;justify-content:center;background:#eee}
    .ad-card .thumb img{width:100%;height:100%;object-fit:cover}
    .ad-body{padding:12px;flex:1;display:flex;flex-direction:column}
    .ad-title{margin:0 0 .4rem;font-size:1.05rem}
    .ad-meta{margin:0 0 .6rem;color:var(--muted);font-size:.9rem}
    .ad-desc{margin:0 0 .8rem;color:#333}
    .ad-bottom{margin-top:auto;display:flex;justify-content:space-between;align-items:center}
    .price{font-weight:700;color:var(--green)}
    .muted{color:var(--muted)}
    .error{color:#c0392b}
    .ad-box,.info-box{background:#fff;padding:12px;border-radius:8px;margin-bottom:12px;box-shadow:0 1px 4px rgba(0,0,0,.04)}
    @media (max-width:900px){.content{flex-direction:column}.sidebar{width:100%}}
  </style>
</body>
</html>
