<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SzakiPiac-2025.hu</title>

    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Atika76/szakipiac-2025/main/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=AQsaQCLj0og2wsfMoDKAqxJieD2cgXwWq5cssAJCJbO2KoYE8LGHCREyR4vMzMfKZK68qw6EY7IAxMYF&currency=HUF"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        .page-content { display: none; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #2d3748; width: 40px; height: 40px; border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
        .gemini-loader { border: 2px solid #f3f3f3; border-top: 2px solid #4f46e5; width: 16px; height: 16px; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .lightbox { transition: opacity 0.3s ease; display: flex; align-items: center; justify-content: center; }
        .aspect-w-16 { position: relative; padding-bottom: 56.25%; }
        .aspect-h-9 > iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="fixed bottom-4 right-4 z-[60] text-xs bg-white border border-gray-200 px-3 py-2 rounded-full shadow-lg flex gap-2 items-center opacity-90 hover:opacity-100 transition">
        <span class="font-bold text-gray-900">HU</span>
        <span class="text-gray-300">|</span>
        <a href="/En/index.html#home" class="text-gray-500 hover:text-green-600 font-medium">EN</a>
    </div>
    
    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                
                <div class="flex items-center mr-4">
                    <a href="#home" class="nav-link-logo flex-shrink-0 flex items-center gap-2 text-xl font-bold text-gray-800">
                        <img class="h-10 w-auto" src="https://raw.githubusercontent.com/Atika76/szakipiac-2025/main/szakipiac-logo-promo.png" alt="Logo">
                    </a>
                </div>
                
                <div class="hidden md:flex items-center space-x-1 flex-grow justify-end">
                    <a href="#home" class="nav-link text-gray-600 hover:bg-gray-100 px-3 py-2 rounded-md text-sm font-medium">F≈ëoldal</a>
                    <a href="#rolunk" class="nav-link text-gray-600 hover:bg-gray-100 px-3 py-2 rounded-md text-sm font-medium">R√≥lunk</a>
                    <a href="#kapcsolat" class="nav-link text-gray-600 hover:bg-gray-100 px-3 py-2 rounded-md text-sm font-medium">Kapcsolat</a>
                    
                    <a href="kalkulator.html" class="text-orange-600 hover:bg-orange-50 px-3 py-2 rounded-md text-sm font-bold border border-orange-200 flex items-center gap-1 shadow-sm ml-2">
                        <span>üßÆ</span> AI Kalkul√°tor
                    </a>

                    <a href="#feltoltes" class="nav-link bg-green-600 text-white hover:bg-green-700 px-3 py-2 rounded-md text-sm font-medium ml-4">Hirdet√©s felt√∂lt√©se</a>
                </div>
                
                <div id="nav-auth-section" class="hidden md:block ml-6 text-sm"></div>
                
                <div class="md:hidden flex items-center ml-auto">
                    <button id="mobile-menu-button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-600 hover:text-black hover:bg-gray-100 focus:outline-none ring-1 ring-gray-300 shadow-sm bg-white">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <div id="mobile-menu" class="md:hidden hidden bg-white border-t border-gray-100 shadow-xl absolute w-full left-0 z-50">
                <div class="px-4 pt-4 pb-6 space-y-2">
                    <a href="#home" class="nav-link text-gray-700 hover:bg-gray-50 block px-3 py-3 rounded-md text-base font-medium border-b border-gray-100">üè† F≈ëoldal</a>
                    <a href="#rolunk" class="nav-link text-gray-700 hover:bg-gray-50 block px-3 py-3 rounded-md text-base font-medium border-b border-gray-100">‚ÑπÔ∏è R√≥lunk</a>
                    <a href="#kapcsolat" class="nav-link text-gray-700 hover:bg-gray-50 block px-3 py-3 rounded-md text-base font-medium border-b border-gray-100">‚úâÔ∏è Kapcsolat</a>
                    
                    <a href="kalkulator.html" class="text-orange-600 bg-orange-50 block px-3 py-3 rounded-md text-base font-bold border border-orange-200 flex items-center gap-2">
                        üßÆ AI √Årkalkul√°tor
                    </a>

                    <a href="#feltoltes" class="nav-link bg-green-600 text-white block px-3 py-3 rounded-md text-base font-medium mt-4 text-center shadow">üì¢ Hirdet√©s felt√∂lt√©se</a>
                    <div id="mobile-nav-auth-section" class="pt-4 mt-4 border-t border-gray-200 text-center"></div>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 min-h-screen">
        <div id="main-loader" class="page-content flex justify-center items-center py-20" style="display: none;"><div class="loader"></div></div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
                <div id="home-page" class="page-content"></div>
                <div id="rolunk-page" class="page-content"></div>
                <div id="kapcsolat-page" class="page-content"></div>
                <div id="feltoltes-page" class="page-content"></div>
                <div id="auth-page" class="page-content"></div>
                <div id="admin-page" class="page-content"></div>
            </div>
            <aside class="hidden lg:block space-y-6">
              <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100 sticky top-24">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 text-center">Partnereink √©s aj√°nlataink</h3>
                
                <div class="relative overflow-hidden rounded-lg shadow-md" style="height: 260px;">
                  <a id="reklam-link" href="#" target="_blank" class="block h-full w-full bg-white flex items-center justify-center">
                      <img id="reklam-img" src="" class="max-h-full max-w-full object-contain p-4" draggable="false">
                  </a>
                  
                  <button id="btn-prev" class="absolute top-1/2 left-2 -translate-y-1/2 bg-white bg-opacity-80 p-2 rounded-full shadow hover:bg-opacity-100 z-10">‚ùÆ</button>
                  <button id="btn-next" class="absolute top-1/2 right-2 -translate-y-1/2 bg-white bg-opacity-80 p-2 rounded-full shadow hover:bg-opacity-100 z-10">‚ùØ</button>
                </div>
              </div>
            </aside>
        </div>
    </main>
    
    <div id="lightbox" class="fixed inset-0 bg-black bg-opacity-80 z-[100] hidden items-center justify-center opacity-0 lightbox backdrop-blur-sm"><span id="lightbox-close" class="absolute top-4 right-6 text-white text-5xl font-bold cursor-pointer hover:text-gray-300">&times;</span><img id="lightbox-img" class="max-w-[95%] max-h-[90%] rounded-lg shadow-2xl"></div>
    <div id="toast-notification" class="fixed top-5 right-5 bg-green-600 text-white py-3 px-6 rounded-lg shadow-xl transform translate-x-[120%] transition-transform duration-300 z-[110] font-medium flex items-center gap-2"></div>

<script type="module">

// 1. KONFIGUR√ÅCI√ì
const SUPABASE_URL = "https://bxtpnotswnwrbycvfypz.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4dHBub3Rzd253cmJ5Y3ZmeXB6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MTQ0NDcsImV4cCI6MjA2ODQ5MDQ0N30.CXEfo_8qmIYhkEZFdTsbl9ZB-PRTP6UK8EbIxxpSGZc";
const supaClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const ADMIN_EMAIL = "atika.76@windowslive.com";

let kivalasztottKepek = [];
let hirdetesekCache = [];

// 2. SEG√âDF√úGGV√âNYEK
function getYouTubeEmbedUrl(url){if(!url)return null;try{const urlObj=new URL(url);let videoId;if(urlObj.hostname==="youtu.be")videoId=urlObj.pathname.slice(1);else if(urlObj.hostname.includes("youtube.com")&&urlObj.searchParams.has("v"))videoId=urlObj.searchParams.get("v");return videoId?`https://www.youtube.com/embed/${videoId}`:null}catch(e){return null}}

function showToast(message, type="success") {
    const toast = document.getElementById("toast-notification");
    toast.textContent = message;
    toast.className = `fixed top-5 right-5 text-white py-3 px-6 rounded-lg shadow-xl transform transition-transform duration-300 z-[110] ${type==="error"?"bg-red-600":"bg-green-600"}`;
    toast.classList.remove("translate-x-[120%]");
    setTimeout(() => toast.classList.add("translate-x-[120%]"), 4000);
}

// 3. REKL√ÅM SLIDER (EGYSZER≈∞S√çTVE)
const reklamok=[
    {url:"#feltoltes",img:"https://raw.githubusercontent.com/Atika76/szakipiac-2025/main/szakipiac-reklam.png"},
    {url:"#feltoltes",img:"https://raw.githubusercontent.com/Atika76/szakipiac-2025/main/szakipiac-logo-promo.png"},
    {url:"https://www.alza.hu/",img:"https://upload.wikimedia.org/wikipedia/commons/1/1f/Alza.cz_logo.svg"},
    {url:"https://www.emag.hu/",img:"https://upload.wikimedia.org/wikipedia/commons/a/af/Logo_eMAG_%282019%29.svg"},
    {url:"https://www.temu.com/",img:"https://upload.wikimedia.org/wikipedia/commons/d/db/Temu_logo_icon.svg"},
    {url:"https://www.lidl.hu/",img:"https://upload.wikimedia.org/wikipedia/commons/thumb/9/91/Lidl-Logo.svg/1200px-Lidl-Logo.svg.png"},
    {url:"https://www.aldi.hu/",img:"https://upload.wikimedia.org/wikipedia/commons/thumb/a/a6/Aldi_S%C3%BCd_logo.svg/1200px-Aldi_S%C3%BCd_logo.svg.png"}
];
let rIndex=0;

function updateSlider(){
    const img = document.getElementById("reklam-img");
    const link = document.getElementById("reklam-link");
    if(!img || !link) return;
    
    const ad = reklamok[rIndex];
    img.src = ad.img;
    link.href = ad.url;
}

function nextAd() { rIndex = (rIndex + 1) % reklamok.length; updateSlider(); }
function prevAd() { rIndex = (rIndex - 1 + reklamok.length) % reklamok.length; updateSlider(); }

// 4. ROUTER
const router = {
    '#home': showHomePage,
    '#rolunk': showRolunkPage,
    '#kapcsolat': showKapcsolatPage,
    '#feltoltes': showFeltoltesPage,
    '#auth': showAuthPage,
    '#admin': showAdminPage
};

async function handleRouteChange() {
    const hash = window.location.hash || "#home";
    document.querySelectorAll(".page-content").forEach(p => p.style.display = "none");
    const loader = document.getElementById("main-loader");
    if(loader) loader.style.display = "flex";
    
    try {
        const handler = router[hash] || router['#home'];
        await handler();
        const activePage = document.getElementById(hash.substring(1)+"-page");
        if(activePage) activePage.style.display = "block";
    } catch(e) { console.error(e); }
    
    if(loader) loader.style.display = "none";
    document.getElementById("mobile-menu")?.classList.add("hidden");
}

// 5. F≈êOLDAL
async function showHomePage() {
    const c = document.getElementById("home-page");
    c.innerHTML = `
        <div class="text-center mb-8"><h1 class="text-4xl font-bold">√údv√∂zl√ºnk a <span class="text-green-600">SzakiPiac-2025.hu</span>-n!</h1></div>
        <div class="bg-white p-6 rounded shadow mb-8">
            <div class="grid md:grid-cols-3 gap-4">
                <input type="text" id="search" placeholder="Keres√©s..." class="w-full border p-2 rounded">
                <input type="text" id="filter-city" placeholder="V√°ros" class="w-full border p-2 rounded">
                <select id="category-select" class="w-full border p-2 rounded">
                    <option value="">√ñsszes kateg√≥ria</option>
                    <option>K≈ëm≈±ves</option>
                    <option>Burkol√≥</option>
                    <option>Fest≈ë</option>
                    <option>Villanyszerel≈ë</option>
                    <option>V√≠z-G√°z-F≈±t√©s</option>
                    <option>√Åcs / Tet≈ëfed≈ë</option>
                    <option>Asztalos</option>
                    <option>Kert√©p√≠t√©s</option>
                    <option>Takar√≠t√°s</option>
                    <option>G√©p√©szet</option>
                    <option>Lakberendez√©s</option>
                    <option>Sz√°m√≠t√°stechnika</option>
                    <option>Egy√©b</option>
                </select>
            </div>
        </div>
        <div id="hirdetes-lista" class="space-y-6"><div class="loader mx-auto"></div></div>
    `;
    document.getElementById("search").addEventListener("input", filterAds);
    document.getElementById("filter-city").addEventListener("input", filterAds);
    document.getElementById("category-select").addEventListener("change", filterAds);
    await loadAds();
}

// --- R√ìLUNK OLDAL ---
async function showRolunkPage(){
    document.getElementById("rolunk-page").innerHTML=`
    <div class="bg-white p-8 rounded-lg shadow-sm">
        <h1 class="text-3xl font-bold mb-6 text-green-700">R√≥lunk</h1>
        <p class="mb-4 text-gray-700 text-lg">A <b>SzakiPiac-2025.hu</b> az orsz√°g leg√∫jabb √©s legdinamikusabban fejl≈ëd≈ë szakember-keres≈ë platformja.</p>
    </div>`;
}

// --- KAPCSOLAT OLDAL ---
async function showKapcsolatPage(){
    const c = document.getElementById("kapcsolat-page");
    c.innerHTML=`
    <div class="bg-white p-8 rounded-lg shadow-sm">
        <h1 class="text-3xl font-bold mb-6 text-green-700">Kapcsolat</h1>
        <p>Email: szakipiac2025@gmail.com</p>
        <form id="contact-form" class="mt-4 space-y-4">
             <input class="w-full border p-2 rounded" placeholder="N√©v"><input class="w-full border p-2 rounded" placeholder="Email"><textarea class="w-full border p-2 rounded" placeholder="√úzenet"></textarea><button class="bg-green-600 text-white px-4 py-2 rounded">K√ºld√©s</button>
        </form>
    </div>`;
    c.querySelector("#contact-form").addEventListener("submit", e=>{e.preventDefault();showToast("K√∂sz√∂nj√ºk!","info");});
}

// 6. HIRDET√âSEK BET√ñLT√âSE
async function loadAds() {
    const listEl = document.getElementById("hirdetes-lista");
    try {
        const {data, error} = await supaClient.from("hirdetesek").select("*").gte("lej√°rati_datum", new Date().toISOString()).order("created_at", {ascending: false});
        if(error) throw error;
        hirdetesekCache = data;
        renderAds(data);
    } catch(e) {
        if(listEl) listEl.innerHTML = `<p class="text-center text-red-600">Hiba a bet√∂lt√©skor.</p>`;
    }
}

function renderAds(list) {
    const listEl = document.getElementById("hirdetes-lista");
    if(!listEl) return;
    if(!list.length) { listEl.innerHTML = "<p class='text-center text-gray-500'>Nincs tal√°lat.</p>"; return; }

    supaClient.auth.getSession().then(({data: {session}}) => {
        listEl.innerHTML = list.map(h => {
            const isOwner = session && session.user.id === h.user_id;
            const isAdmin = session && session.user.email === ADMIN_EMAIL;
            const video = getYouTubeEmbedUrl(h.video_url) ? `<div class="aspect-w-16 aspect-h-9 mt-4"><iframe src="${getYouTubeEmbedUrl(h.video_url)}" class="w-full h-full rounded" allowfullscreen></iframe></div>` : "";
            const images = h.kep_url_tomb ? `<div class="flex gap-2 mt-2 overflow-x-auto">${h.kep_url_tomb.map(u => `<img src="${u}" class="h-24 w-24 object-cover rounded cursor-pointer" onclick="window.openLightbox('${u}')">`).join("")}</div>` : "";
            const delBtn = (isOwner || isAdmin) ? `<button onclick="window.deleteAd('${h.id}')" class="text-red-600 text-sm px-3 py-1 border border-red-200 rounded hover:bg-red-50">T√∂rl√©s</button>` : "";
            const extraClass = h.csomag === 'extra' ? 'border-2 border-yellow-400 shadow-lg' : '';
            const extraBadge = h.csomag === 'extra' ? '<div class="absolute top-0 right-0 bg-yellow-400 text-xs font-bold px-2 py-1 rounded-bl text-white">KIEMELT</div>' : '';
            
            return `
                <div class="bg-white p-6 rounded-lg shadow-sm relative ${extraClass}">
                    ${extraBadge}
                    <div class="flex justify-between">
                        <div><p class="text-sm font-bold text-green-600 uppercase">${h.kategoria || ""} ${h.varos ? `‚Ä¢ ${h.varos}` : ""}</p><h3 class="text-xl font-bold mt-1">${h.cim}</h3></div>
                        <div class="text-lg font-bold">${h.ar ? parseInt(h.ar).toLocaleString() + " Ft" : ""}</div>
                    </div>
                    <p class="text-gray-600 my-4 whitespace-pre-line">${h.leiras}</p>
                    ${images}
                    ${video}
                    <div class="mt-4 flex flex-wrap justify-between items-center border-t pt-4">
                        <div class="flex gap-2 flex-wrap">
                            <a href="mailto:${h.email}" class="bg-green-600 text-white px-3 py-1.5 rounded text-sm flex items-center gap-1">üìß Email</a>
                            ${h.telefonszam ? `<a href="tel:${h.telefonszam}" class="bg-gray-100 text-gray-700 px-3 py-1.5 rounded text-sm flex items-center gap-1">üìû H√≠v√°s</a>` : ""}
                            ${h.weboldal ? `<a href="${h.weboldal}" target="_blank" class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm flex items-center gap-1 hover:bg-blue-700">üåê Weboldal</a>` : ""}
                        </div>
                        ${delBtn}
                    </div>
                </div>
            `;
        }).join("");
    });
}
function filterAds() {
    const txt = document.getElementById("search").value.toLowerCase();
    const cat = document.getElementById("category-select").value;
    const city = document.getElementById("filter-city").value.toLowerCase();
    
    const filtered = hirdetesekCache.filter(h => {
        const mTxt = (h.cim + h.leiras).toLowerCase().includes(txt);
        const mCat = !cat || cat === "√ñsszes kateg√≥ria" || h.kategoria === cat;
        const mCity = !city || (h.varos && h.varos.toLowerCase().includes(city));
        return mTxt && mCat && mCity;
    });
    renderAds(filtered);
}

// 7. FELT√ñLT√âS
async function showFeltoltesPage() {
    const {data: {session}} = await supaClient.auth.getSession();
    const c = document.getElementById("feltoltes-page");
    if(!session) { c.innerHTML = `<div class="bg-blue-50 border border-blue-200 text-blue-700 p-4 rounded text-center">A hirdet√©s felad√°s√°hoz <a href="#auth" class="font-bold underline">jelentkezz be!</a></div>`; return; }
    
    kivalasztottKepek = [];
    c.innerHTML = `
        <div class="bg-white p-6 rounded shadow-sm">
            <h1 class="text-2xl font-bold mb-4">Hirdet√©s felad√°sa</h1>
            <div class="bg-indigo-50 p-4 rounded mb-6 border border-indigo-100"><h3 class="text-indigo-800 font-bold mb-2">‚ú® AI Sz√∂veg√≠r√≥</h3><div class="flex gap-2"><input id="ai-keywords" placeholder="Pl: szobafest√©s" class="flex-grow border p-2 rounded"><button onclick="generateAI()" class="bg-indigo-600 text-white px-4 rounded">√çrd meg!</button></div></div>
            <form id="ad-form" class="space-y-4">
                <input id="cim" placeholder="C√≠m" class="w-full border p-2 rounded" required>
                <textarea id="leiras" placeholder="Le√≠r√°s" class="w-full border p-2 rounded" rows="5" required></textarea>
                <div class="grid md:grid-cols-2 gap-4"><input id="varos" placeholder="V√°ros" class="w-full border p-2 rounded" required><input id="iranyitoszam" placeholder="Ir√°ny√≠t√≥sz√°m" class="w-full border p-2 rounded"></div>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <select id="kategoria" class="w-full border p-2 rounded" required>
                        <option value="">V√°lassz kateg√≥ri√°t...</option>
                        <option>K≈ëm≈±ves</option>
                        <option>Burkol√≥</option>
                        <option>Fest≈ë</option>
                        <option>Villanyszerel≈ë</option>
                        <option>V√≠z-G√°z-F≈±t√©s</option>
                        <option>√Åcs / Tet≈ëfed≈ë</option>
                        <option>Asztalos</option>
                        <option>Kert√©p√≠t√©s</option>
                        <option>Takar√≠t√°s</option>
                        <option>G√©p√©szet</option>
                        <option>Lakberendez√©s</option>
                        <option>Sz√°m√≠t√°stechnika</option>
                        <option>Egy√©b</option>
                    </select>
                    <input id="telefonszam" placeholder="Telefonsz√°m" class="w-full border p-2 rounded">
                </div>
                <div class="grid md:grid-cols-2 gap-4"><input id="weboldal" placeholder="Weboldal" class="w-full border p-2 rounded"><div id="video-wrapper"><input id="video" placeholder="YouTube vide√≥" class="w-full border p-2 rounded"></div></div>
                <input id="ar" type="number" placeholder="√År (Ft)" class="w-full border p-2 rounded">
                <div class="border p-4 rounded bg-gray-50"><label class="font-bold mb-2 block">Csomag:</label><select id="csomag" class="w-full border p-2 rounded mb-2" onchange="updatePackageInfo()"><option value="alap">Alap (Ingyen, 2 k√©p)</option><option value="premium">Pr√©mium (990 Ft, 4 k√©p)</option><option value="extra">Extra (1990 Ft, 8 k√©p)</option></select><p id="package-info" class="text-sm text-gray-600"></p></div>
                <div class="border-dashed border-2 border-gray-300 p-6 text-center rounded"><label class="cursor-pointer block"><span class="text-green-600 font-bold">K√©pek</span> (Max <span id="max-img">2</span>)<input type="file" id="file-input" multiple accept="image/*" class="hidden" onchange="handleFileSelect(this)"></label><div id="preview-container" class="flex gap-2 justify-center mt-4 flex-wrap"></div></div>
                <div id="submit-area"><button type="submit" class="w-full bg-green-600 text-white py-3 rounded font-bold">Bek√ºld√©s</button></div><div id="paypal-container" class="hidden mt-4"></div>
            </form>
        </div>`;

    window.generateAI = async () => {
        const k = document.getElementById("ai-keywords").value;
        if(!k) return;
        try {
            const {data} = await supaClient.functions.invoke('generate-ad', {body: {query: k}});
            if(data && data.title) { document.getElementById("cim").value = data.title; document.getElementById("leiras").value = data.description; showToast("K√©sz!"); }
        } catch(e) { showToast("Hiba az AI-n√°l","error"); }
    };

    window.updatePackageInfo = () => {
        const val = document.getElementById("csomag").value;
        const vWrap = document.getElementById("video-wrapper");
        const info = document.getElementById("package-info");
        const max = document.getElementById("max-img");
        const sub = document.getElementById("submit-area");
        const pp = document.getElementById("paypal-container");
        
        let m = 2, p = 0;
        vWrap.style.display = "none"; 
        
        if(val === 'premium') { m=4; p=990; info.innerText="4 k√©p, Vide√≥, 14 nap"; vWrap.style.display="block"; }
        else if(val === 'extra') { m=8; p=1990; info.innerText="8 k√©p, Vide√≥, Kiemelt, 30 nap"; vWrap.style.display="block"; }
        else { info.innerText="2 k√©p, 7 nap (Vide√≥ nem el√©rhet≈ë)"; document.getElementById("video").value=""; }
        
        max.innerText = m;
        if(p > 0 && session.user.email !== ADMIN_EMAIL) {
            sub.style.display = "none"; pp.style.display = "block"; pp.innerHTML = "";
            paypal.Buttons({createOrder:(d,a)=>a.order.create({purchase_units:[{amount:{value:p, currency_code:'HUF'}}]}), onApprove:(d,a)=>a.order.capture().then(()=>processUpload())}).render('#paypal-container');
        } else { sub.style.display = "block"; pp.style.display = "none"; }
    };

    window.handleFileSelect = async (input) => {
        const files = Array.from(input.files);
        const max = parseInt(document.getElementById("max-img").innerText);
        if(kivalasztottKepek.length + files.length > max) return showToast("T√∫l sok k√©p!", "error");
        for(const f of files) { try { const c = await imageCompression(f, {maxSizeMB: 1, maxWidthOrHeight: 1280}); kivalasztottKepek.push(c); } catch(e){} }
        renderPreview();
    };

    document.getElementById("ad-form").addEventListener("submit", (e) => { e.preventDefault(); processUpload(); });
    updatePackageInfo();
}

function renderPreview() {
    document.getElementById("preview-container").innerHTML = kivalasztottKepek.map((f, i) => `
        <div class="relative"><img src="${URL.createObjectURL(f)}" class="h-16 w-16 object-cover rounded"><button onclick="removeImg(${i})" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5">&times;</button></div>
    `).join("");
}
window.removeImg = (i) => { kivalasztottKepek.splice(i, 1); renderPreview(); };

async function processUpload() {
    const {data: {session}} = await supaClient.auth.getSession();
    const cim = document.getElementById("cim").value;
    if(!cim) return showToast("Adj meg c√≠met!", "error");
    
    showToast("Felt√∂lt√©s...", "info");
    
    try {
        const imgUrls = [];
        for(const file of kivalasztottKepek) {
            const ext = file.name.split('.').pop();
            const safeName = `${Date.now()}_${Math.floor(Math.random() * 100000)}.${ext}`;
            const path = `${session.user.id}/${safeName}`;
            const {error: upErr} = await supaClient.storage.from('hirdetes-kepek').upload(path, file);
            if(upErr) throw upErr;
            const {data} = supaClient.storage.from('hirdetes-kepek').getPublicUrl(path);
            imgUrls.push(data.publicUrl);
        }

        const csomag = document.getElementById("csomag").value;
        const days = csomag === 'extra' ? 30 : (csomag === 'premium' ? 14 : 7);
        const lejarat = new Date();
        lejarat.setDate(lejarat.getDate() + days);

        const {error} = await supaClient.from('hirdetesek').insert({
            user_id: session.user.id,
            email: session.user.email,
            cim: cim,
            leiras: document.getElementById("leiras").value,
            varos: document.getElementById("varos").value,
            iranyitoszam: document.getElementById("iranyitoszam").value,
            kategoria: document.getElementById("kategoria").value,
            telefonszam: document.getElementById("telefonszam").value,
            weboldal: document.getElementById("weboldal").value,
            video_url: document.getElementById("video").value,
            ar: document.getElementById("ar").value || null,
            csomag: csomag,
            kep_url_tomb: imgUrls,
            lej√°rati_datum: lejarat.toISOString()
        });

        if(error) throw error;
        showToast("Sikeres felt√∂lt√©s!", "success");
        window.location.hash = "#home";
    } catch(e) {
        console.error(e);
        showToast("Hiba: " + e.message, "error");
    }
}

// 8. AUTH & ADMIN (JAV√çTOTT ADMIN T√ÅBL√ÅZAT D√ÅTUMMAL)
async function showAuthPage() {
    const c = document.getElementById("auth-page");
    c.innerHTML = `<div class="bg-white p-8 rounded shadow-sm max-w-md mx-auto text-center"><h2 class="text-2xl font-bold mb-4">Bejelentkez√©s</h2><form id="login-form" class="space-y-4"><input type="email" name="email" placeholder="Email" class="w-full border p-2 rounded" required><input type="password" name="password" placeholder="Jelsz√≥" class="w-full border p-2 rounded" required><button class="w-full bg-green-600 text-white p-2 rounded">Mehet</button></form></div>`;
    document.getElementById("login-form").addEventListener("submit", async e => {
        e.preventDefault();
        const email = e.target.email.value;
        const password = e.target.password.value;
        const {error} = await supaClient.auth.signInWithPassword({email, password});
        if(error) {
             const {error: upErr} = await supaClient.auth.signUp({email, password});
             if(upErr) showToast(upErr.message, "error");
             else showToast("Regisztr√°ci√≥ sikeres! L√©pj be.");
        } else {
            showToast("Sikeres bel√©p√©s!");
            window.location.hash = "#home";
        }
    });
}
async function showAdminPage() {
    const {data:{session}} = await supaClient.auth.getSession();
    if(!session || session.user.email !== ADMIN_EMAIL) return document.getElementById("admin-page").innerHTML = "<p class='text-center text-red-500'>Nincs jogod.</p>";
    
    const {data} = await supaClient.from("hirdetesek").select("*").order("created_at", {ascending: false});
    document.getElementById("admin-page").innerHTML = `
        <div class="bg-white p-6 rounded shadow">
            <h2 class="text-xl font-bold mb-4">Admin Panel</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead><tr class="bg-gray-100 text-left"><th class="p-2">C√≠m</th><th class="p-2">Email</th><th class="p-2">Lej√°rat</th><th class="p-2">M≈±velet</th></tr></thead>
                    <tbody>
                    ${data.map(h => `
                        <tr class="border-b">
                            <td class="p-2 font-bold">${h.cim}</td>
                            <td class="p-2 text-gray-600">${h.email}</td>
                            <td class="p-2 text-blue-600">${new Date(h.lej√°rati_datum).toLocaleDateString('hu-HU')}</td>
                            <td class="p-2"><button onclick="window.deleteAd('${h.id}')" class="text-red-600 font-bold hover:underline">T√∂rl√©s</button></td>
                        </tr>`).join("")}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}
window.deleteAd = async (id) => {
    if(!confirm("Biztos?")) return;
    await supaClient.from("hirdetesek").delete().eq("id", id);
    showAdminPage();
    showToast("T√∂r√∂lve");
};

// 9. IND√çT√ÅS
async function init() {
    const {data: {session}} = await supaClient.auth.getSession();
    const navAuth = document.getElementById("nav-auth-section");
    
    const adminLink = (session && session.user.email === ADMIN_EMAIL) ? '<a href="#admin" class="text-yellow-600 font-bold text-sm ml-2">ADMIN</a>' : '';
    
    const authHTML = session 
        ? `<div class="flex items-center gap-3"><span class="text-sm font-bold truncate max-w-[150px]">${session.user.email}</span>${adminLink}<button onclick="window.doLogout()" class="text-sm text-red-600 hover:underline ml-2">Kil√©p√©s</button></div>` 
        : `<a href="#auth" class="text-green-600 font-bold hover:underline">Bel√©p√©s</a>`;
        
    navAuth.innerHTML = authHTML;

    window.doLogout = async () => { await supaClient.auth.signOut(); window.location.reload(); };
    
    window.addEventListener("hashchange", handleRouteChange);
    document.querySelectorAll(".nav-link, .nav-link-logo").forEach(l => {
        l.addEventListener("click", e => {
            if(l.getAttribute('href') === 'kalkulator.html') return;
            e.preventDefault();
            window.location.hash = new URL(l.href).hash;
        });
    });

    document.getElementById("mobile-menu-button").addEventListener("click", () => {
        document.getElementById("mobile-menu").classList.toggle("hidden");
    });

    document.getElementById("btn-next").addEventListener("click", nextReklam);
    document.getElementById("btn-prev").addEventListener("click", prevReklam);

    document.getElementById("lightbox-close").addEventListener("click", () => document.getElementById("lightbox").classList.add("hidden"));

    handleRouteChange();
    updateSlider(); // Slider ind√≠t√°sa
    setInterval(nextReklam, 4000);
}

window.openLightbox = (u) => {
    document.getElementById("lightbox-img").src = u;
    document.getElementById("lightbox").classList.remove("hidden");
};

init();
</script>
</body>
</html>
