<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SzakiPiac-2025.hu</title> <link rel="icon" sizes="192x192" href="icon-192.png" />
  <link rel="icon" sizes="512x512" href="icon-512.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <script>
    if (typeof window.supaClient === "undefined") {
      const SUPABASE_URL = "https://bxtpnotswnwrbycvfypz.supabase.co";
      const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4dHBub3Rzd253cmJ5Y3ZmeXB6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MTQ0NDcsImV4cCI6MjA2ODQ5MDQ0N30.CXEfo_8qmIYhkEZFdTsbl9ZB-PRTP6UK8EbIxxpSGZc";
      window.supaClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    }
  </script>
  <script src="https://www.paypal.com/sdk/js?client-id=AQsaQCLj0og2wsfMoDKAqxJieD2cgXwWq5cssAJCJbO2KoYE8LGHCREyR4vMzMfKZK68qw6EY7IAxMYF&currency=HUF"></script>
  <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2/dist/browser-image-compression.js"></script>

  <style>
    :root { --brand-yellow:#F7B500; --brand-blue:#1e64c8; --brand-red:#e11d21; }
    body{font-family:Inter,system-ui,Arial,Helvetica,sans-serif;background:#f7fafc;color:#1f2937}
    .page-content{display:none}
    .loader{width:40px;height:40px;border-radius:9999px;border:4px solid #eee;border-top-color:#2d3748;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .promo-tile{background:var(--brand-yellow);border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.08)}
    .promo-icon{filter: drop-shadow(0 3px 6px rgba(0,0,0,.15))}
    .flag{width:16px;height:12px;display:inline-block;vertical-align:baseline;border:1px solid rgba(0,0,0,.15);border-radius:2px;overflow:hidden}
  </style>
</head>
<body>

  <div id="lang-switcher" class="fixed top-2 right-3 z-[60] text-xs text-gray-600 bg-white/80 backdrop-blur px-2 py-1 rounded-md shadow-sm">
    </div>

  <header class="bg-white shadow-md sticky top-0 z-50">
    <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <a href="#home" class="nav-link-logo flex items-center gap-2 font-extrabold text-xl text-gray-800">
          <img class="h-8 w-8" src="icon-192.png" alt="SzakiPiac logo">
          <span>SzakiPiac-2025.hu</span>
        </a>

        <div class="hidden md:flex items-center gap-1">
          <a href="#home" class="nav-link px-3 py-2 rounded-md text-sm font-medium" data-i18n="navHome">Főoldal</a>
          <a href="#about" class="nav-link px-3 py-2 rounded-md text-sm font-medium" data-i18n="navAbout">Rólunk</a>
          <a href="#contact" class="nav-link px-3 py-2 rounded-md text-sm font-medium" data-i18n="navContact">Kapcsolat</a>
          <a href="#post" class="nav-link px-3 py-2 rounded-md text-sm font-medium bg-green-600 text-white" data-i18n="navPost">Hirdetés feladása</a>
        </div>

        <div class="flex items-center gap-2">
          <div id="nav-auth-section" class="hidden md:block"></div>
          <button id="mobile-menu-button" class="md:hidden p-2 text-gray-600">
            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
          </button>
        </div>
      </div>

      <div id="mobile-menu" class="md:hidden hidden">
        <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
          <a href="#home" class="nav-link block px-3 py-2 rounded-md" data-i18n="navHome">Főoldal</a>
          <a href="#about" class="nav-link block px-3 py-2 rounded-md" data-i18n="navAbout">Rólunk</a>
          <a href="#contact" class="nav-link block px-3 py-2 rounded-md" data-i18n="navContact">Kapcsolat</a>
          <a href="#post" class="nav-link block px-3 py-2 rounded-md bg-green-600 text-white" data-i18n="navPost">Hirdetés feladása</a>
          <div id="mobile-nav-auth-section" class="pt-4 mt-4 border-t"></div>
        </div>
      </div>
    </nav>
  </header>

  <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div id="main-loader" class="page-content flex justify-center items-center py-20" style="display:none">
      <div class="loader"></div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <div class="lg:col-span-2">
        <div id="home-page" class="page-content"></div>
        <div id="about-page" class="page-content"></div>
        <div id="contact-page" class="page-content"></div>
        <div id="post-page" class="page-content"></div>
        <div id="auth-page" class="page-content"></div>
        <div id="admin-page" class="page-content"></div>
      </div>

      <aside class="hidden lg:block space-y-6">
        <div class="bg-white p-6 rounded-lg shadow-sm">
          <h3 id="sidebar-title" class="text-lg font-semibold text-center mb-4" data-i18n="sidebarTitle">Partnerek és ajánlatok</h3>
          <div id="ad-slider" class="relative overflow-hidden rounded-lg shadow-md" style="height: 260px;">
            <div id="ad-slides"></div>
            <div id="ad-dots" class="absolute bottom-2 left-1/2 -translate-x-1/2 flex gap-2"></div>
            <button id="slider-prev" class="absolute top-1/2 left-2 -translate-y-1/2 bg-white/80 p-2 rounded-full shadow z-10" data-i18n-aria-label="sliderPrev">
              <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 19l-7-7 7-7"/></svg>
            </button>
            <button id="slider-next" class="absolute top-1/2 right-2 -translate-y-1/2 bg-white/80 p-2 rounded-full shadow z-10" data-i18n-aria-label="sliderNext">
              <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5l7 7-7 7"/></svg>
            </button>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <div id="lightbox" class="fixed inset-0 bg-black/75 z-[100] hidden items-center justify-center opacity-0 transition">
    <span id="lightbox-close" class="absolute top-4 right-6 text-white text-5xl font-bold cursor-pointer">&times;</span>
    <img id="lightbox-img" class="max-w-[90%] max-h-[85%] rounded-lg">
  </div>

  <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-x-[120%] transition duration-300 z-[110]"></div>

<script>
/* ========= i18n Globals ========= */
window.i18n = {}; // Fordítások tárolója
window.currentLang = 'hu'; // Alapértelmezett nyelv
const allLangs = ['hu', 'en'];
const defaultLang = 'hu';

/* ========= Helpers ========= */
const ADMIN_EMAIL = "atika.76@windowslive.com";
function showToast(msg,type="success"){const el=document.getElementById("toast");el.textContent=msg;el.className=`fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transform transition duration-300 z-[110] ${type==='error'?'bg-red-500':'bg-green-500'}`;el.classList.remove("translate-x-[120%]");setTimeout(()=>el.classList.add("translate-x-[120%]"),4000)}
function ytEmbed(url){if(!url)return null;try{const u=new URL(url);let id;if(u.hostname==="youtu.be")id=u.pathname.slice(1);else if(u.hostname.includes("youtube.com")&&u.searchParams.has("v"))id=u.searchParams.get("v");return id?`https://www.youtube.com/embed/${id}`:null}catch{return null}}

/* ========= i18n Functions ========= */
// Betölti a megfelelő .json fájlt
async function loadTranslations(lang) {
  try {
    const response = await fetch(`${lang}.json`);
    if (!response.ok) throw new Error('Network response was not ok');
    window.i18n = await response.json();
    window.currentLang = lang;
    document.documentElement.lang = lang; // Frissíti a <html> lang attribútumot
    applyTranslations();
  } catch (error) {
    console.error('Failed to load translation:', error);
  }
}

// Végigmegy az oldalon és beilleszti a fordításokat
function applyTranslations() {
  const i18n = window.i18n;
  if (!i18n.pageTitle) return; // Ne fusson le, amíg nincs adat

  // 1. Statikus szövegek (data-i18n)
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (i18n[key]) el.innerHTML = i18n[key]; // innerHTML a <b> és <span> tagek miatt
  });
  // 2. Placeholderek
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const key = el.getAttribute('data-i18n-placeholder');
    if (i18n[key]) el.placeholder = i18n[key];
  });
  // 3. Aria-labelek
  document.querySelectorAll('[data-i18n-aria-label]').forEach(el => {
    const key = el.getAttribute('data-i18n-aria-label');
    if (i18n[key]) el.setAttribute('aria-label', i18n[key]);
  });
  // 4. Dinamikus Href-ek (pl. a #post oldali figyelmeztetésben)
  document.querySelectorAll('[data-i18n-href]').forEach(el => {
    const key = el.getAttribute('data-i18n-href');
    if (i18n[key]) el.href = i18n[key].replace('%LANG%', window.currentLang);
  });

  // 5. Oldal címe és Manifest
  updateHead();
  
  // 6. Nyelvi váltó frissítése
  updateLangSwitcher();
}

// Frissíti az oldal <head> részét (cím, manifest)
function updateHead() {
  document.title = window.i18n.pageTitle || 'SzakiPiac-2025.hu';
  
  // Régi manifest eltávolítása
  let oldManifest = document.querySelector('link[rel="manifest"]');
  if (oldManifest) oldManifest.remove();

  // Új, nyelv-specifikus manifest hozzáadása
  let manifest = document.createElement('link');
  manifest.rel = 'manifest';
  manifest.href = `manifest.${window.currentLang}.json`;
  document.head.appendChild(manifest);
}

// Frissíti a nyelvi váltó linkjeit és kinézetét
function updateLangSwitcher() {
  const i18n = window.i18n;
  const switcher = document.getElementById("lang-switcher");
  const currentPage = (window.location.hash.split('/')[1] || 'home');
  
  const huClass = window.currentLang === 'hu' ? 'font-bold text-gray-900' : 'hover:underline text-gray-600';
  const enClass = window.currentLang === 'en' ? 'font-bold text-gray-900' : 'hover:underline text-gray-600';

  switcher.innerHTML = `
    <a href="#hu/${currentPage}" class="${huClass} mr-2" title="Magyar">
      <span class="flag align-[-1px]">
        <svg viewBox="0 0 3 2" width="16" height="12">
          <rect width="3" height="2" fill="#fff"/><rect width="3" height="0.6667" y="0" fill="#ce2939"/><rect width="3" height="0.6667" y="1.3333" fill="#477050"/>
        </svg>
      </span> ${i18n.langHU || 'HU'}
    </a>
    <span class="opacity-60">|</span>
    <a href="#en/${currentPage}" class="${enClass} ml-2" title="English">
      <span class="flag align-[-1px]">
        <svg viewBox="0 0 60 30" width="16" height="12">
          <clipPath id="s-en"><path d="M0,0 v30 h60 v-30 z"/></clipPath><clipPath id="t-en"><path d="M30,15 h30 v15 z v15 h-30 z h-30 v-15 z v-15 h30 z"/></clipPath>
          <g clip-path="url(#s-en)"><path d="M0,0 v30 h60 v-30 z" fill="#012169"/><path d="M0,0 L60,30 M60,0 L0,30" stroke="#fff" stroke-width="6"/><path d="M0,0 L60,30 M60,0 L0,30" clip-path="url(#t-en)" stroke="#C8102E" stroke-width="4"/><path d="M30,0 v30 M0,15 h60" stroke="#fff" stroke-width="10"/><path d="M30,0 v30 M0,15 h60" stroke="#C8102E" stroke-width="6"/></g>
        </svg>
      </span> ${i18n.langEN || 'EN'}
    </a>
  `;
}


/* ========= Promo blocks (HTML instead of baked text images) ========= */
function promoCard(){
  const i18n = window.i18n;
  return `
  <div class="promo-tile p-6 sm:p-8">
    <div class="flex items-center gap-4 sm:gap-6">
      <img class="promo-icon w-16 sm:w-20" src="icon-192.png" alt="">
      <div>
        <div class="text-2xl sm:text-3xl font-extrabold tracking-tight">SzakiPiac<span class="text-black">-2025</span><span class="text-[var(--brand-red)]">.hu</span></div>
        <div class="text-lg sm:text-xl font-semibold text-[var(--brand-blue)]" data-i18n="promoTitle">${i18n.promoTitle}</div>
      </div>
    </div>
    <div class="mt-5 grid grid-cols-2 gap-4 text-sm sm:text-base">
      <div class="bg-white/80 rounded-xl p-3 shadow" data-i18n="promo1"><b>✔</b> ${i18n.promo1}</div>
      <div class="bg-white/80 rounded-xl p-3 shadow" data-i18n="promo2"><b>✔</b> ${i18n.promo2}</div>
      <div class="bg-white/80 rounded-xl p-3 shadow" data-i18n="promo3"><b>✔</b> ${i18n.promo3}</div>
      <div class="bg-white/80 rounded-xl p-3 shadow" data-i18n="promo4"><b>✔</b> ${i18n.promo4}</div>
    </div>
  </div>`;
}
function megaphoneCta(){
  const i18n = window.i18n;
  return `
  <a href="#${window.currentLang}/post" class="block w-full h-[250px] promo-tile p-6 hover:brightness-105 transition">
    <div class="flex items-start gap-4">
      <svg class="promo-icon w-16 h-16" viewBox="0 0 24 24" fill="none" stroke="#1e64c8" stroke-width="1.5">
        <path d="M3 11l16-5v12L3 13v-2Z"/><path d="M11 14c0 3-1 5-3 5s-3-2-3-5"/>
      </svg>
      <div>
        <div class="text-2xl font-extrabold leading-snug" data-i18n="ctaTitle">${i18n.ctaTitle}</div>
        <div class="text-lg mt-1" data-i18n="ctaSub">${i18n.ctaSub}</div>
      </div>
    </div>
  </a>`;
}

/* ========= Slider ========= */
function sliderItems(){
  return [
    { type:'html', html:promoCard },
    { type:'html', html:megaphoneCta },
    { type:'img', url:"https://www.alza.hu/", img:"https://upload.wikimedia.org/wikipedia/commons/1/1f/Alza.cz_logo.svg", alt:"Alza.hu" },
    { type:'img', url:"https://www.emag.hu/", img:"https://upload.wikimedia.org/wikipedia/commons/a/af/Logo_eMAG_%282019%29.svg", alt:"eMAG" }
  ];
}
let slideIdx=0, slideTimer=null;
function renderSlide(i){
  const host=document.getElementById("ad-slides"); const items=sliderItems(); const ad=items[i];
  host.innerHTML = ad.type==='html'
    ? ad.html()
    : `<a href="${ad.url}" target="_blank" rel="noopener sponsored" class="block w-full h-[250px]">
         <img src="${ad.img}" alt="${ad.alt||''}" class="w-full h-full object-contain p-2 bg-white rounded-md shadow">
       </a>`;
  document.getElementById("ad-dots").innerHTML = items.map((_,k)=>`
    <button class="w-3 h-3 rounded-full border-2 ${k===i?'bg-green-600 border-green-700':'bg-white border-gray-400'}"
            onclick="showSlide(${k})" aria-label="Slide ${k+1}"></button>`).join("");
}
function showSlide(i){slideIdx=i;renderSlide(slideIdx);resetTimer()}
function prevSlide(){const items=sliderItems();slideIdx=(slideIdx-1+items.length)%items.length;renderSlide(slideIdx);resetTimer()}
function nextSlide(){const items=sliderItems();slideIdx=(slideIdx+1)%items.length;renderSlide(slideIdx);resetTimer()}
function resetTimer(){if(slideTimer)clearInterval(slideTimer);const items=sliderItems();if(items.length>1)slideTimer=setInterval(nextSlide,4000)}

/* ========= Router ========= */
const router = {
  '#home': showHome,
  '#about': showAbout,
  '#contact': showContact,
  '#post': showPost,
  '#auth': showAuth,
  '#admin': showAdmin
};
function showPage(id){document.querySelectorAll(".page-content").forEach(p=>{if(p.id!=="main-loader")p.style.display="none"});document.getElementById(id+"-page").style.display="block"}

async function handleRouteChange(){
  document.querySelectorAll(".page-content").forEach(p=>p.style.display="none");
  const loader=document.getElementById("main-loader"); loader.style.display="flex";

  // Új, kétnyelvű hash kezelés
  const hash = window.location.hash || `#${defaultLang}/home`;
  const parts = hash.substring(1).split('/');
  let lang = parts[0];
  let page = parts[1];

  // Nyelv és oldal validálása
  if (!allLangs.includes(lang)) {
    lang = defaultLang;
    page = parts[0] || 'home';
    window.location.hash = `${lang}/${page}`;
    return; // Újratöltés a helyes hash-sel
  }
  if (!page || !router['#' + page]) {
    page = 'home';
    window.location.hash = `${lang}/${page}`;
    return; // Újratöltés a helyes hash-sel
  }
  
  const pageKey = '#' + page;

  // Fordítás betöltése, ha a nyelv változott
  if (lang !== window.currentLang) {
    await loadTranslations(lang);
  } else {
    // Ha a nyelv nem változott, csak a fordításokat alkalmazzuk (pl. nyelvi váltó linkjeinek frissítéséhez)
    applyTranslations();
  }

  // Oldal betöltése
  const fn=router[pageKey]||router["#home"];
  try{await fn()}catch(e){console.error(e)}finally{loader.style.display="none";showPage(page)}
  
  // Aktív nav link beállítása
  document.querySelectorAll(".nav-link").forEach(a => {
    const linkPage = (new URL(a.href)).hash.substring(1); // '#home' -> 'home'
    a.classList.toggle("bg-gray-100", linkPage === page);
  });
  document.getElementById("mobile-menu").classList.add("hidden");
}

/* ========= Pages ========= */
async function showHome(){
  const i18n = window.i18n;
  const el=document.getElementById("home-page");
  el.innerHTML = `
    <div class="text-center mb-8">
      <h1 class="text-4xl font-extrabold" data-i18n="homeTitle">${i18n.homeTitle}</h1>
      <p class="mt-3 text-lg text-gray-600" data-i18n="homeSub">${i18n.homeSub}</p>
    </div>

    <div class="mb-12">${promoCard()}</div>

    <div class="bg-white p-6 rounded-lg shadow-sm mb-8">
      <h2 class="text-2xl font-bold text-center mb-4" data-i18n="browseTitle">${i18n.browseTitle}</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <input id="search-input" class="md:col-span-2 w-full border-gray-300 rounded-md" data-i18n-placeholder="searchPlaceholder" placeholder="${i18n.searchPlaceholder}" />
        <select id="category-select" class="w-full border-gray-300 rounded-md">
          <option value="" data-i18n="allCategories">${i18n.allCategories}</option>
          <option value="${i18n.cat1}">${i18n.cat1}</option>
          <option value="${i18n.cat2}">${i18n.cat2}</option>
          <option value="${i18n.cat3}">${i18n.cat3}</option>
          <option value="${i18n.cat4}">${i18n.cat4}</option>
          <option value="${i18n.cat5}">${i18n.cat5}</option>
          <option value="${i18n.cat6}">${i18n.cat6}</option>
          <option value="${i18n.cat7}">${i18n.cat7}</option>
          <option value="${i18n.cat8}">${i18n.cat8}</option>
        </select>
      </div>
    </div>

    <div id="ads-list" class="space-y-6">
      <div class="flex justify-center py-10"><div class="loader"></div></div>
    </div>`;
  el.querySelector("#search-input").addEventListener("input",applyFilter);
  el.querySelector("#category-select").addEventListener("change",applyFilter);
  await loadAds();
}
async function showAbout(){
  const i18n = window.i18n;
  document.getElementById("about-page").innerHTML = `
    <div class="bg-white p-8 rounded-lg shadow-sm">
      <h1 class="text-3xl font-extrabold mb-6" data-i18n="aboutTitle">${i18n.aboutTitle}</h1>
      <p class="mb-4 text-gray-700" data-i18n="aboutP1">${i18n.aboutP1}</p>
      <ul class="space-y-3 my-6">
        <li data-i18n="aboutLi1">${i18n.aboutLi1}</li>
        <li data-i18n="aboutLi2">${i18n.aboutLi2}</li>
        <li data-i18n="aboutLi3">${i18n.aboutLi3}</li>
        <li data-i18n="aboutLi4">${i18n.aboutLi4}</li>
        <li data-i18n="aboutLi5">${i18n.aboutLi5}</li>
      </ul>
      <p class="mb-4 text-gray-700" data-i18n="aboutP2">${i18n.aboutP2}</p>
    </div>`;
}
async function showContact(){
  const i18n = window.i18n;
  const c=document.getElementById("contact-page");
  c.innerHTML = `
    <div class="bg-white p-8 rounded-lg shadow-sm">
      <h1 class="text-3xl font-extrabold mb-6" data-i18n="contactTitle">${i18n.contactTitle}</h1>
      <div class="grid md:grid-cols-2 gap-12">
        <div>
          <h3 class="text-xl font-semibold" data-i18n="contactInfo">${i18n.contactInfo}</h3>
          <p class="mt-4"><b>Email:</b> <a href="mailto:szakipiac2025@gmail.com" class="text-green-600">szakipiac2025@gmail.com</a></p>
        </div>
        <div>
          <h3 class="text-xl font-semibold mb-4" data-i18n="contactFormTitle">${i18n.contactFormTitle}</h3>
          <form id="contact-form" class="space-y-4">
            <div><label data-i18n="contactName">${i18n.contactName}</label><input id="c-name" class="mt-1 block w-full border-gray-300 rounded-md" required></div>
            <div><label data-i18n="contactEmail">${i18n.contactEmail}</label><input id="c-email" type="email" class="mt-1 block w-full border-gray-300 rounded-md" required></div>
            <div><label data-i18n="contactMsg">${i18n.contactMsg}</label><textarea id="c-msg" rows="4" class="mt-1 block w-full border-gray-300 rounded-md" required></textarea></div>
            <button class="w-full bg-green-600 text-white py-2 rounded-md" data-i18n="contactSend">${i18n.contactSend}</button>
          </form>
        </div>
      </div>
    </div>`;
  c.querySelector("#contact-form").addEventListener("submit",e=>{
    e.preventDefault();showToast(i18n.contactToast,"info");e.target.reset();
  });
}
async function showAuth(){
  const i18n = window.i18n;
  const el=document.getElementById("auth-page");
  const { data:{ session } } = await supaClient.auth.getSession();
  if(session){ el.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-sm text-center"><h1 class="text-2xl font-bold mb-4" data-i18n="authLoggedIn">${i18n.authLoggedIn}</h1><p class="text-gray-600">${session.user.email}</p></div>`; return; }
  el.innerHTML = `
    <div class="bg-white p-8 rounded-lg shadow-sm max-w-md mx-auto">
      <h2 id="auth-title" class="text-2xl font-bold text-center mb-6" data-i18n="authTitleIn">${i18n.authTitleIn}</h2>
      <form id="auth-form" class="space-y-6">
        <div><label class="block text-sm" data-i18n="authEmail">${i18n.authEmail}</label><input id="email" type="email" required class="mt-1 w-full border-gray-300 rounded-md"></div>
        <div><label class="block text-sm" data-i18n="authPass">${i18n.authPass}</label><input id="password" type="password" required class="mt-1 w-full border-gray-300 rounded-md"></div>
        <button id="auth-submit" class="w-full text-white bg-green-600 hover:bg-green-700 py-2 rounded-md" data-i18n="authBtnIn">${i18n.authBtnIn}</button>
      </form>
      <div class="mt-6 text-center"><a href="#" id="auth-switch" class="text-sm text-green-600 hover:text-green-500" data-i18n="authSwitchUp">${i18n.authSwitchUp}</a></div>
    </div>`;
  let login=true;
  el.querySelector("#auth-form").addEventListener("submit",async e=>{
    e.preventDefault();
    const email=e.target.email.value, password=e.target.password.value;
    try{
      const { error } = login ? await supaClient.auth.signInWithPassword({email,password})
                              : await supaClient.auth.signUp({email,password});
      if(error) throw error;
      showToast(login ? i18n.authToastIn : i18n.authToastUp);
      location.hash=`#${window.currentLang}/home`;
    }catch(err){showToast(i18n.authToastErr.replace("{message}", err.message),"error")}
  });
  el.querySelector("#auth-switch").addEventListener("click",e=>{
    e.preventDefault(); login=!login;
    el.querySelector("#auth-title").textContent=login?i18n.authTitleIn:i18n.authTitleUp;
    el.querySelector("#auth-submit").textContent=login?i18n.authBtnIn:i18n.authBtnUp;
    e.target.textContent=login?i18n.authSwitchUp:i18n.authSwitchIn;
  });
}
async function showPost(){
  const i18n = window.i18n;
  const el=document.getElementById("post-page");
  const { data:{ session } } = await supaClient.auth.getSession();
  const authLink = i18n.authLink.replace('%LANG%', window.currentLang);
  const warn = !session? `<div class="bg-blue-100 border-l-4 border-blue-500 text-blue-800 p-4 mb-6 rounded-md" data-i18n="postWarn">${i18n.postWarn.replace(i18n.authLink, authLink)}</div>` : ``;
  window._imgs=[];

  el.innerHTML = `
    <div class="bg-white p-8 rounded-lg shadow-sm">
      ${warn}
      <h1 class="text-3xl font-extrabold mb-2" data-i18n="postTitle">${i18n.postTitle}</h1>
      <p class="text-gray-600 mb-8" data-i18n="postSub">${i18n.postSub}</p>

      <div class="bg-indigo-50 border border-indigo-200 p-6 rounded-lg mb-8">
        <h2 class="text-xl font-semibold text-indigo-800 mb-3" data-i18n="aiTitle">${i18n.aiTitle}</h2>
        <div class="flex flex-col sm:flex-row gap-2">
          <input id="ai-kw" class="flex-grow w-full px-4 py-2 border-indigo-300 rounded-md" data-i18n-placeholder="aiPlaceholder" placeholder="${i18n.aiPlaceholder}">
          <button id="ai-btn" class="inline-flex items-center justify-center px-4 py-2 text-sm text-white bg-indigo-600 rounded-md" data-i18n="aiBtn">${i18n.aiBtn}</button>
        </div>
      </div>

      <form id="post-form" class="space-y-6">
        <div><label class="block text-sm" data-i18n="formTitle">${i18n.formTitle}</label><input id="title" required class="mt-1 w-full border-gray-300 rounded-md"></div>
        <div><label class="block text-sm" data-i18n="formDesc">${i18n.formDesc}</label><textarea id="desc" rows="6" required class="mt-1 w-full border-gray-300 rounded-md"></textarea></div>

        <div class="grid md:grid-cols-2 gap-6">
          <div><label class="block text-sm" data-i18n="formCat">${i18n.formCat}</label>
            <select id="cat" required class="mt-1 w-full border-gray-300 rounded-md">
              <option value="" data-i18n="formCatChoose">${i18n.formCatChoose}</option>
              <option value="${i18n.cat1}">${i18n.cat1}</option>
              <option value="${i18n.cat2}">${i18n.cat2}</option>
              <option value="${i18n.cat3}">${i18n.cat3}</option>
              <option value="${i18n.cat4}">${i18n.cat4}</option>
              <option value="${i18n.cat5}">${i18n.cat5}</option>
              <option value="${i18n.cat6}">${i18n.cat6}</option>
              <option value="${i18n.cat7}">${i18n.cat7}</option>
              <option value="${i18n.cat8}">${i18n.cat8}</option>
            </select>
          </div>
          <div><label class="block text-sm" data-i18n="formPhone">${i18n.formPhone}</label><input id="phone" data-i18n-placeholder="formPhonePlaceholder" placeholder="${i18n.formPhonePlaceholder}" class="mt-1 w-full border-gray-300 rounded-md"></div>
          <div><label class="block text-sm" data-i18n="formWebsite">${i18n.formWebsite}</label><input id="website" data-i18n-placeholder="formWebsitePlaceholder" placeholder="${i18n.formWebsitePlaceholder}" class="mt-1 w-full border-gray-300 rounded-md"></div>
          <div id="yt-wrap" class="hidden"><label class="block text-sm" data-i18n="formYT">${i18n.formYT}</label><input id="yt" data-i18n-placeholder="formYTPlaceholder" placeholder="${i18n.formYTPlaceholder}" class="mt-1 w-full border-gray-300 rounded-md"></div>
        </div>

        <div><label class="block text-sm" data-i18n="formPrice">${i18n.formPrice}</label><input id="price" type="number" min="0" data-i18n-placeholder="formPricePlaceholder" placeholder="${i18n.formPricePlaceholder}" class="mt-1 w-full border-gray-300 rounded-md"></div>

        <div>
          <label class="block text-sm" data-i18n="formPkg">${i18n.formPkg}</label>
          <select id="pkg" required class="mt-1 w-full border-gray-300 rounded-md">
            <option value="basic_0_2" data-i18n="pkg1">${i18n.pkg1}</option>
            <option value="premium_1990_4" data-i18n="pkg2">${i18n.pkg2}</option>
            <option value="extra_2990_8" data-i18n="pkg3">${i18n.pkg3}</option>
          </select>
        </div>

        <div id="pkg-desc" class="mt-4 p-4 bg-gray-50 rounded-lg border text-sm"></div>

        <div>
          <label class="block text-sm"><span data-i18n="formImgs">${i18n.formImgs.replace("{max}", 2)}</span> (<span id="max-imgs">2</span>)</label>
          <label class="inline-block mt-1 cursor-pointer text-green-600 underline">
            <span data-i18n="formImgsChoose">${i18n.formImgsChoose}</span> <input id="img-input" type="file" multiple accept="image/*" class="sr-only">
          </label>
          <div id="img-previews" class="mt-4 grid grid-cols-3 sm:grid-cols-5 gap-4"></div>
        </div>

        <div class="border-t pt-6">
          <div id="free-submit"><button id="submit-btn" class="w-full bg-green-600 text-white py-3 rounded-md" data-i18n="formSubmit">${i18n.formSubmit}</button></div>
          <div id="paypal-wrap" class="hidden"></div>
        </div>
      </form>
    </div>`;
  // események
  el.querySelector("#ai-btn").addEventListener("click",genAiText);
  el.querySelector("#pkg").addEventListener("change",onPkgChange);
  el.querySelector("#img-input").addEventListener("change",onImgPick);
  el.querySelector("#submit-btn").addEventListener("click",(e)=>{e.preventDefault();submitAd()});
  onPkgChange();
}
async function showAdmin(){
  const i18n = window.i18n;
  const el=document.getElementById("admin-page");
  el.innerHTML=`<div class="flex justify-center py-10"><div class="loader"></div></div>`;
  const { data:{ session } } = await supaClient.auth.getSession();
  if(!session || session.user.email!==ADMIN_EMAIL){ el.innerHTML = `<p class="text-red-500 text-center" data-i18n="adminNoAccess">${i18n.adminNoAccess}</p>`; return; }
  try{
    const { data:list, error } = await supaClient.from("hirdetesek").select("*").order("created_at",{ascending:false});
    if(error) throw error;
    el.innerHTML = `
      <h2 class="text-2xl font-extrabold mb-4" data-i18n="adminTitle">${i18n.adminTitle}</h2>
      <div class="bg-white rounded-lg shadow-sm overflow-x-auto">
        <table class="w-full text-sm text-left">
          <thead class="bg-gray-50"><tr>
            <th class="p-4" data-i18n="adminColTitle">${i18n.adminColTitle}</th>
            <th class="p-4" data-i18n="adminColUser">${i18n.adminColUser}</th>
            <th class="p-4" data-i18n="adminColExpires">${i18n.adminColExpires}</th>
            <th class="p-4" data-i18n="adminColActions">${i18n.adminColActions}</th>
          </tr></thead>
          <tbody>
            ${list.map(h=>`<tr class="border-b">
              <td class="p-4">${h.cim}</td>
              <td class="p-4">${h.email}</td>
              <td class="p-4 whitespace-nowrap">${h.lejárati_datum?(new Date(h.lejárati_datum)).toLocaleDateString(window.currentLang === 'hu' ? 'hu-HU' : 'en-GB'):i18n.adminTblNA}</td>
              <td class="p-4"><button onclick="deleteAd('${h.id}')" class="text-red-600 hover:underline" data-i18n="adminTblDel">${i18n.adminTblDel}</button></td>
            </tr>`).join("")}
          </tbody>
        </table>
      </div>`;
  }catch(e){ el.innerHTML = `<p class="text-red-500 text-center">${i18n.adminErr.replace('{message}', e.message)}</p>`; }
}

/* ========= Data + actions ========= */
async function loadAds(){
  const host=document.getElementById("ads-list");
  try{
    const { data, error } = await supaClient.from("hirdetesek").select("*").gte("lejárati_datum",(new Date).toISOString());
    if(error) throw error;
    const weight={extra:3,premium:2,basic:1,alap:1};
    data.sort((a,b)=> (weight[b.csomag]||0)-(weight[a.csomag]||0) || (new Date(b.created_at)-new Date(a.created_at)));
    window._ads=data;
    renderAds(data);
  }catch(e){ host.innerHTML = `<p class="text-center text-red-600" data-i18n="adsError">${window.i18n.adsError}</p>`; }
}
function renderAds(list){
  const i18n = window.i18n;
  const host=document.getElementById("ads-list");
  if(!list?.length){ host.innerHTML = `<p class="text-center text-gray-500" data-i18n="adsNone">${i18n.adsNone}</p>`; return; }
  host.innerHTML = list.map(h=>{
    const yt=ytEmbed(h.video_url);
    const video = yt?`<div class="aspect-video my-4 rounded-lg overflow-hidden shadow"><iframe src="${yt}" allowfullscreen class="w-full h-full"></iframe></div>`:"";
    const imgs=(h.kep_url_tomb||[]).length?`<div class="flex flex-wrap gap-2 mb-4">${h.kep_url_tomb.map(u=>`<img src="${u}" class="h-20 w-20 object-cover rounded-md cursor-pointer" onclick="openLightbox('${u}')">`).join("")}</div>`:"";
    const price = h.ar ? (Number(h.ar).toLocaleString(window.currentLang === 'hu' ? 'hu-HU' : 'en-US') + (window.currentLang === 'hu' ? " Ft" : " HUF")) : i18n.adPriceNego;
    return `
      <div class="bg-white p-6 rounded-lg shadow-sm relative ${h.csomag==='extra'?'border-2 border-yellow-400':''}">
        ${h.csomag==='extra'?`<div class="absolute top-0 right-0 -mt-3 -mr-3 bg-yellow-400 text-white text-xs font-bold px-2 py-1 rounded-full shadow">EXTRA</div>`:""}
        <div class="flex justify-between items-start">
          <div>
            <p class="text-sm font-medium text-green-600">${h.kategoria||""}</p>
            <h3 class="text-xl font-bold mt-1">${h.cim}</h3>
          </div>
          <p class="text-lg font-semibold">${price}</p>
        </div>
        <p class="text-gray-600 my-4">${h.leiras}</p>
        ${video}${imgs}
        <div class="flex flex-wrap gap-2 pt-4 border-t justify-between items-center">
          <div>
            <a class="px-3 py-1.5 text-sm text-white bg-green-600 rounded-md" href="mailto:${h.email}" data-i18n="adContactEmail">${i18n.adContactEmail}</a>
            ${h.telefonszam?`<a class="px-3 py-1.5 text-sm bg-gray-200 rounded-md" href="tel:${h.telefonszam}" data-i18n="adContactPhone">${i18n.adContactPhone}</a>`:""}
            ${h.weboldal?`<a class="px-3 py-1.5 text-sm text-white bg-blue-600 rounded-md" rel="noopener nofollow" target="_blank" href="${h.weboldal}" data-i18n="adWebsite">${i18n.adWebsite}</a>`:""}
          </div>
          ${window._sessionEmail===ADMIN_EMAIL?`<button onclick="deleteAd('${h.id}')" class="px-3 py-1.5 text-sm text-white bg-red-600 rounded-md" data-i18n="adDelete">${i18n.adDelete}</button>`:""}
        </div>
      </div>`;
  }).join("");
}
function applyFilter(){
  const q=document.getElementById("search-input").value.toLowerCase();
  const catEl=document.getElementById("category-select");
  const cat=catEl.value;
  const list=(window._ads||[]).filter(h=>{
    const mTxt=`${h.cim} ${h.leiras}`.toLowerCase().includes(q);
    const mCat=!cat || h.kategoria===cat;
    return mTxt && mCat;
  });
  renderAds(list);
}

async function submitAd(){
  const i18n = window.i18n;
  const { data:{ session } } = await supaClient.auth.getSession();
  if(!session){showToast(i18n.toastMustSignIn,"error");return}
  const ad=getAd(); if(!ad) return;
  showToast(i18n.toastUploading,"info");
  try{
    const urls=await uploadImgs(window._imgs||[]);
    await saveAd(ad,urls);
  }catch(e){showToast(i18n.toastErrGeneric.replace('{message}', e.message),"error")}
}
function getAd(){
  const i18n = window.i18n;
  const title=document.getElementById("title").value;
  const desc=document.getElementById("desc").value;
  if(!title||!desc){showToast(i18n.toastMissingFields,"error");return null}
  return {
    cim:title, leiras:desc, kategoria:document.getElementById("cat").value,
    ar:document.getElementById("price").value||null, telefonszam:document.getElementById("phone").value||null,
    weboldal:document.getElementById("website").value||null, video_url:document.getElementById("yt").value||null
  };
}
async function uploadImgs(files){
  const { data:{ session } } = await supaClient.auth.getSession(); if(!session||!files.length) return [];
  const ups = await Promise.all(files.map(f=>supaClient.storage.from("hirdetes-kepek").upload(`${session.user.id}/${Date.now()}_${f.name}`,f)));
  const urls=[]; for(const r of ups){ if(r.error) throw r.error; const { data } = supaClient.storage.from("hirdetes-kepek").getPublicUrl(r.data.path); urls.push(data.publicUrl) }
  return urls;
}
async function saveAd(ad,urls){
  const i18n = window.i18n;
  const { data:{ session } } = await supaClient.auth.getSession();
  const pkg=document.getElementById("pkg").value.split("_")[0];
  const days={basic:7,premium:14,extra:30,alap:7}[pkg]||7;
  const exp=new Date(); exp.setDate(exp.getDate()+days);
  const { error } = await supaClient.from("hirdetesek").insert({...ad,user_id:session.user.id,email:session.user.email,csomag:pkg,kep_url_tomb:urls,lejárati_datum:exp.toISOString()});
  if(error){showToast(i18n.toastSaveErr.replace('{message}', error.message),"error")} 
  else {showToast(i18n.toastSaveOK,"success");location.hash=`#${window.currentLang}/home`}
}

/* PayPal + package */
function onPkgChange(){
  const i18n = window.i18n;
  const s=document.getElementById("pkg"); const [name,price,max]=s.value.split("_"); 
  document.getElementById("max-imgs").textContent=max;
  // Frissítjük a "Képek (X db)" szöveget is
  const imgLabel = document.querySelector('[data-i18n="formImgs"]');
  if (imgLabel) imgLabel.innerHTML = i18n.formImgs.replace('{max}', max);

  const wrap=document.getElementById("yt-wrap"); wrap.classList.toggle("hidden",!(name==="premium"||name==="extra"));
  const free=document.getElementById("free-submit"); const pp=document.getElementById("paypal-wrap");
  (window._sessionEmail===ADMIN_EMAIL||price==0) ? (free.style.display="block", pp.style.display="none", pp.innerHTML="")
    : (free.style.display="none", pp.style.display="block", pp.innerHTML="", paypal.Buttons({
        createOrder:(d,a)=>{ if(!getAd()) return Promise.reject(new Error("invalid")); return a.order.create({purchase_units:[{description:`SzakiPiac package: ${name}`,amount:{currency_code:"HUF",value:price}}]})},
        onApprove:(d,a)=>a.order.capture().then(()=>submitAd()),
        onError:(e)=>showToast(i18n.toastPkgInvalid,"error")
      }).render("#paypal-wrap"));
}
async function genAiText(){
  const i18n = window.i18n;
  const kw=document.getElementById("ai-kw").value.trim();
  if(!kw){showToast(i18n.toastAiKw,"error");return}
  const btn=document.getElementById("ai-btn"); const old=btn.textContent; btn.disabled=true; btn.textContent=i18n.aiBtnGen;
  try{
    // A 'generate-ad' funkciónak a 'query' kulcsot küldjük, ahogy az index.ts várja
    const { data, error } = await supaClient.functions.invoke("generate-ad",{body:{query:kw}});
    if(error) throw new Error(error.message||"Function error");
    document.getElementById("title").value=data.title; // 'cim' helyett 'title' (ahogy az index.ts küldi)
    document.getElementById("desc").value=data.description; // 'leiras' helyett 'description'
    showToast(i18n.toastAiOK,"success");
  }catch(e){showToast(i18n.toastAiErr.replace('{message}', e.message),"error")}
  finally{btn.disabled=false; btn.textContent=old}
}
async function deleteAd(id){
  const i18n = window.i18n;
  if(!confirm(i18n.toastDelConfirm)) return;
  try{
    const { data:ad } = await supaClient.from("hirdetesek").select("kep_url_tomb").eq("id",id).single();
    if(ad?.kep_url_tomb?.length){
      const files=ad.kep_url_tomb.map(u=>(new URL(u)).pathname.split("/hirdetes-kepek/")[1]);
      await supaClient.storage.from("hirdetes-kepek").remove(files);
    }
    const { error } = await supaClient.from("hirdetesek").delete().eq("id",id);
    if(error) throw error;
    showToast(i18n.toastDelOK,"success"); 
    // Újratöltjük az adatokat (ha a home oldalon vagyunk) vagy az admin oldalt
    if (location.hash.endsWith('/home')) loadAds();
    if (location.hash.endsWith('/admin')) showAdmin();
  }catch(e){showToast(i18n.toastDelErr.replace('{message}', e.message),"error")}
}

/* Auth UI + slider init */
async function updateAuthUI() {
  const i18n = window.i18n;
  const { data:{ session } } = await supaClient.auth.getSession();
  window._sessionEmail = session?.user?.email || null;
  const nav=document.getElementById("nav-auth-section");
  const mnav=document.getElementById("mobile-nav-auth-section");
  let html="";
  if(session){
    const isAdmin = session.user.email===ADMIN_EMAIL;
    html=`<div class="flex items-center gap-4"><span class="text-sm hidden lg:inline">${session.user.email}</span>
          ${isAdmin?`<a href="#${window.currentLang}/admin" class="text-sm font-medium text-yellow-600" data-i18n="navAdmin">${i18n.navAdmin}</a>`:""}
          <button id="logoutBtn" class="text-sm font-medium" data-i18n="navSignOut">${i18n.navSignOut}</button></div>`;
  }else{
    html=`<a href="#${window.currentLang}/auth" class="text-base font-medium text-gray-500 hover:text-gray-900" data-i18n="navSignIn">${i18n.navSignIn}</a>`;
  }
  nav.innerHTML=html; mnav.innerHTML=html.replace("hidden lg:inline","");
  if(session) document.querySelectorAll("#logoutBtn").forEach(b=>b.addEventListener("click",async()=>{
    await supaClient.auth.signOut();
    showToast(i18n.toastSignOut);
    location.hash=`#${window.currentLang}/home`;
  }));
}

document.addEventListener("DOMContentLoaded",async()=>{
  const lb=document.getElementById("lightbox");
  document.getElementById("lightbox-close").addEventListener("click",()=>{lb.classList.add("opacity-0");setTimeout(()=>lb.classList.add("hidden"),300)});
  window.openLightbox=(url)=>{document.getElementById("lightbox-img").src=url;lb.classList.remove("hidden");setTimeout(()=>lb.classList.remove("opacity-0"),10)};

  // router
  window.addEventListener("hashchange", handleRouteChange);

  // Nav linkek (az aloldalra ugranak az AKTUÁLIS nyelven)
  document.querySelectorAll(".nav-link, .nav-link-logo").forEach(a=>{
    a.addEventListener("click", e => {
      e.preventDefault();
      const pageHash = (new URL(a.href)).hash; // pl. '#home', '#about'
      const newPage = pageHash.substring(1) || 'home';
      location.hash = `${window.currentLang}/${newPage}`; // pl. '#hu/home'
    })
  });
  document.getElementById("mobile-menu-button").addEventListener("click",()=>document.getElementById("mobile-menu").classList.toggle("hidden"));

  // slider
  renderSlide(slideIdx);
  document.getElementById("slider-prev")?.addEventListener("click",prevSlide);
  document.getElementById("slider-next")?.addEventListener("click",nextSlide);
  resetTimer();

  // Auth UI frissítés figyelése
  supaClient.auth.onAuthStateChange(async()=>{
    await updateAuthUI();
    // Újratöltjük az aktuális oldalt, hogy a jogosultságok (pl. admin, post) frissüljenek
    handleRouteChange();
  });

  // Első oldalbetöltés
  handleRouteChange();
});
</script>
</body>
</html>